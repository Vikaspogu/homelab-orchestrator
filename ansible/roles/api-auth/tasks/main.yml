# CloudStack API Authentication - Main Tasks
# This role retrieves or generates CloudStack API keys
# Sets: cloudstack_api_key, cloudstack_api_secret, cloudstack_session_key, cloudstack_cookies
---
- name: Login to CloudStack and get session
  ansible.builtin.uri:
    url: "{{ cloudstack_api_url }}"
    method: POST
    body_format: form-urlencoded
    body:
      command: login
      username: "{{ cloudstack_admin_username }}"
      password: "{{ cloudstack_admin_password }}"
      response: json
    return_content: true
    status_code: [200]
  register: login_response
  no_log: true

- name: Extract session key and cookies
  ansible.builtin.set_fact:
    cloudstack_session_key: "{{ login_response.json.loginresponse.sessionkey }}"
    cloudstack_cookies: "{{ login_response.cookies_string }}"
  no_log: true

- name: Get user account details
  ansible.builtin.uri:
    url: "{{ cloudstack_api_url }}"
    method: POST
    body_format: form-urlencoded
    body:
      command: listUsers
      response: json
      sessionkey: "{{ cloudstack_session_key }}"
    headers:
      Cookie: "{{ cloudstack_cookies }}"
    return_content: true
  register: users_response

- name: Find admin user
  ansible.builtin.set_fact:
    admin_user: "{{ users_response.json.listusersresponse.user | selectattr('username', 'equalto', cloudstack_admin_username) | first }}"

- name: Check if API keys exist
  ansible.builtin.set_fact:
    api_keys_exist: "{{ admin_user.apikey is defined and admin_user.apikey | default('') | length > 0 }}"

- name: Get existing API keys
  when: api_keys_exist
  block:
    - name: Retrieve user keys
      ansible.builtin.uri:
        url: "{{ cloudstack_api_url }}"
        method: POST
        body_format: form-urlencoded
        body:
          command: getUserKeys
          id: "{{ admin_user.id }}"
          response: json
          sessionkey: "{{ cloudstack_session_key }}"
        headers:
          Cookie: "{{ cloudstack_cookies }}"
        return_content: true
      register: get_keys_response
      no_log: true

    - name: Set API keys from existing keys
      ansible.builtin.set_fact:
        cloudstack_api_key: "{{ get_keys_response.json.getuserkeysresponse.userkeys.apikey }}"
        cloudstack_api_secret: "{{ get_keys_response.json.getuserkeysresponse.userkeys.secretkey }}"
      no_log: true

- name: Generate API keys if they don't exist
  when: not api_keys_exist
  block:
    - name: Generate new API keys
      ansible.builtin.uri:
        url: "{{ cloudstack_api_url }}"
        method: POST
        body_format: form-urlencoded
        body:
          command: registerUserKeys
          id: "{{ admin_user.id }}"
          response: json
          sessionkey: "{{ cloudstack_session_key }}"
        headers:
          Cookie: "{{ cloudstack_cookies }}"
        return_content: true
      register: keys_response

    - name: Set API keys from response
      ansible.builtin.set_fact:
        cloudstack_api_key: "{{ keys_response.json.registeruserkeysresponse.userkeys.apikey }}"
        cloudstack_api_secret: "{{ keys_response.json.registeruserkeysresponse.userkeys.secretkey }}"
      no_log: true

- name: Display API key info
  ansible.builtin.debug:
    msg: "CloudStack API keys configured successfully"
