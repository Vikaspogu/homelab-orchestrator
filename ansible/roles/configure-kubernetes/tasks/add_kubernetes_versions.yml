# Add Kubernetes Supported Versions
---
- name: List all zones
  ngine_io.cloudstack.zone_info:
    api_url: "{{ cloudstack_api_url }}"
    api_key: "{{ cloudstack_api_key }}"
    api_secret: "{{ cloudstack_api_secret }}"
    api_timeout: 300
  register: zones_info

- name: Build zone name to ID mapping
  ansible.builtin.set_fact:
    zone_id_map: "{{ zone_id_map | default({}) | combine({item.name: item.id}) }}"
  loop: "{{ zones_info.zones | default([]) }}"

- name: List existing Kubernetes supported versions
  ansible.builtin.uri:
    url: "{{ cloudstack_api_url }}"
    method: POST
    body_format: form-urlencoded
    body:
      command: listKubernetesSupportedVersions
      response: json
      sessionkey: "{{ cloudstack_session_key }}"
    headers:
      Cookie: "{{ cloudstack_cookies }}"
    return_content: true
  register: existing_versions

- name: Build list of existing semantic versions
  ansible.builtin.set_fact:
    existing_semantic_versions: "{{ existing_versions.json.listkubernetessupportedversionsresponse.kubernetessupportedversion | default([]) | map(attribute='semanticversion') | list }}"

- name: Add Kubernetes supported versions
  ansible.builtin.uri:
    url: "{{ cloudstack_api_url }}"
    method: POST
    body_format: form-urlencoded
    body:
      command: addKubernetesSupportedVersion
      name: "{{ item.name }}"
      semanticversion: "{{ item.semantic_version }}"
      url: "{{ item.url }}"
      zoneid: "{{ item.zone_id | default(zone_id_map[item.zone_name]) }}"
      mincpunumber: "{{ item.min_cpu | default(2) }}"
      minmemory: "{{ item.min_memory | default(2048) }}"
      directdownload: true
      response: json
      sessionkey: "{{ cloudstack_session_key }}"
    headers:
      Cookie: "{{ cloudstack_cookies }}"
    return_content: true
  loop: "{{ cloudstack_kubernetes_versions }}"
  register: add_version_results
  when: item.semantic_version not in existing_semantic_versions
  failed_when: >
    add_version_results is failed and
    'already exists' not in (add_version_results.json.addkubernetessupportedversionresponse.errortext | default(''))

- name: Display added Kubernetes versions
  ansible.builtin.debug:
    msg: |
      Kubernetes versions processed:
      {% for version in cloudstack_kubernetes_versions %}
      - {{ version.name }} ({{ version.semantic_version }}): {{ 'Added' if version.semantic_version not in existing_semantic_versions else 'Already exists' }}
      {% endfor %}

