# Lookup CloudStack resource IDs by name
---
- name: Get all zones
  ansible.builtin.uri:
    url: "{{ cloudstack_api_url }}"
    method: POST
    body_format: form-urlencoded
    body:
      command: listZones
      response: json
      sessionkey: "{{ cloudstack_session_key }}"
    headers:
      Cookie: "{{ cloudstack_cookies }}"
    return_content: true
    timeout: "{{ kubernetes_api_timeout }}"
  register: zones_response

- name: Build zone ID map
  ansible.builtin.set_fact:
    _zone_ids: "{{ _zone_ids | default({}) | combine({item.name: item.id}) }}"
  loop: "{{ zones_response.json.listzonesresponse.zone | default([]) }}"

- name: Get all service offerings
  ansible.builtin.uri:
    url: "{{ cloudstack_api_url }}"
    method: POST
    body_format: form-urlencoded
    body:
      command: listServiceOfferings
      response: json
      sessionkey: "{{ cloudstack_session_key }}"
    headers:
      Cookie: "{{ cloudstack_cookies }}"
    return_content: true
    timeout: "{{ kubernetes_api_timeout }}"
  register: offerings_response

- name: Build service offering ID map
  ansible.builtin.set_fact:
    _offering_ids: "{{ _offering_ids | default({}) | combine({item.name: item.id}) }}"
  loop: "{{ offerings_response.json.listserviceofferingsresponse.serviceoffering | default([]) }}"

- name: Get Kubernetes supported versions
  ansible.builtin.uri:
    url: "{{ cloudstack_api_url }}"
    method: POST
    body_format: form-urlencoded
    body:
      command: listKubernetesSupportedVersions
      response: json
      sessionkey: "{{ cloudstack_session_key }}"
    headers:
      Cookie: "{{ cloudstack_cookies }}"
    return_content: true
    timeout: "{{ kubernetes_api_timeout }}"
  register: k8s_versions_response

- name: Build Kubernetes version ID map
  ansible.builtin.set_fact:
    _k8s_version_ids: "{{ _k8s_version_ids | default({}) | combine({item.name: item.id}) }}"
  loop: "{{ k8s_versions_response.json.listkubernetessupportedversionsresponse.kubernetessupportedversion | default([]) }}"

- name: Get all networks
  ansible.builtin.uri:
    url: "{{ cloudstack_api_url }}"
    method: POST
    body_format: form-urlencoded
    body:
      command: listNetworks
      response: json
      sessionkey: "{{ cloudstack_session_key }}"
    headers:
      Cookie: "{{ cloudstack_cookies }}"
    return_content: true
    timeout: "{{ kubernetes_api_timeout }}"
  register: networks_response

- name: Build network ID map
  ansible.builtin.set_fact:
    _network_ids: "{{ _network_ids | default({}) | combine({item.name: item.id}) }}"
  loop: "{{ networks_response.json.listnetworksresponse.network | default([]) }}"

- name: Get OS types
  ansible.builtin.uri:
    url: "{{ cloudstack_api_url }}"
    method: POST
    body_format: form-urlencoded
    body:
      command: listOsTypes
      description: "{{ kubernetes_cks_template.os_type | default('Ubuntu 22.04') }}"
      response: json
      sessionkey: "{{ cloudstack_session_key }}"
    headers:
      Cookie: "{{ cloudstack_cookies }}"
    return_content: true
    timeout: "{{ kubernetes_api_timeout }}"
  register: ostypes_response
  when: kubernetes_cks_template.name | default('') | length > 0

- name: Set OS type ID
  ansible.builtin.set_fact:
    _ostype_id: "{{ ostypes_response.json.listostypesresponse.ostype[0].id }}"
  when:
    - kubernetes_cks_template.name | default('') | length > 0
    - ostypes_response.json.listostypesresponse.ostype | default([]) | length > 0

- name: Get all templates
  ansible.builtin.uri:
    url: "{{ cloudstack_api_url }}"
    method: POST
    body_format: form-urlencoded
    body:
      command: listTemplates
      templatefilter: all
      response: json
      sessionkey: "{{ cloudstack_session_key }}"
    headers:
      Cookie: "{{ cloudstack_cookies }}"
    return_content: true
    timeout: "{{ kubernetes_api_timeout }}"
  register: templates_response

- name: Build template ID map
  ansible.builtin.set_fact:
    _template_ids: "{{ _template_ids | default({}) | combine({item.name: item.id}) }}"
  loop: "{{ templates_response.json.listtemplatesresponse.template | default([]) }}"

- name: Display available resources
  ansible.builtin.debug:
    msg: |
      Available CloudStack Resources:

      Zones: {{ _zone_ids.keys() | list | join(', ') }}
      Service Offerings: {{ _offering_ids.keys() | list | join(', ') }}
      Kubernetes Versions: {{ _k8s_version_ids.keys() | list | join(', ') }}
      Networks: {{ _network_ids.keys() | list | join(', ') }}
      Templates: {{ _template_ids.keys() | list | join(', ') }}
  when: _zone_ids is defined

