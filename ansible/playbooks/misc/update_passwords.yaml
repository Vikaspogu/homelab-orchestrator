# Update user and root passwords on target machines
---
- name: Update passwords on all machines
  hosts: all
  become: true
  gather_facts: true
  vars_files:
    - ../../vars/common.vault.yaml

  vars:
    # Users to update passwords for
    password_update_users:
      - username: root
        password: "{{ password_update_root_password }}"
      - username: "{{ password_update_default_user }}"
        password: "{{ password_update_user_password }}"

  tasks:
    - name: Validate required variables
      ansible.builtin.assert:
        that:
          - password_update_root_password is defined
          - password_update_user_password is defined
          - password_update_default_user is defined
        fail_msg: |
          Required variables not set. Please define in your vault:
            - password_update_root_password
            - password_update_user_password
            - password_update_default_user

    - name: Update user passwords
      ansible.builtin.user:
        name: "{{ item.username }}"
        password: "{{ item.password | password_hash('sha512') }}"
        update_password: always
      loop: "{{ password_update_users }}"
      loop_control:
        label: "{{ item.username }}"
      no_log: true
      register: password_update_result

    - name: Ensure password expiry is not set (optional)
      ansible.builtin.command: "chage -M 99999 {{ item.username }}"
      loop: "{{ password_update_users }}"
      loop_control:
        label: "{{ item.username }}"
      changed_when: true
      when: password_update_disable_expiry | default(true)

    - name: Display update summary
      ansible.builtin.debug:
        msg: |
          Password Update Summary for {{ inventory_hostname }}:
          {% for item in password_update_result.results %}
            - {{ item.item.username }}: {{ 'Updated' if item.changed else 'No change' }}
          {% endfor %}
