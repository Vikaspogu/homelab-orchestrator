---
- name: Deploy OMV VMs on all proxmox hosts
  hosts: proxmox
  gather_facts: false
  pre_tasks:
    # Option 1: Use 1Password (set onepassword_enabled=true)
    - name: Fetch Proxmox credentials from 1Password
      onepassword.connect.item_info:
        vault: "{{ lookup('env', 'OP_VAULT') }}"
        item: "{{ onepassword_item_proxmox | default('proxmox') }}"
      delegate_to: localhost
      register: onepassword_proxmox_item
      when: onepassword_enabled | default(false) | bool
      no_log: true

    - name: Set Proxmox credentials from 1Password
      ansible.builtin.set_fact:
        proxmox_api_user: "{{ (onepassword_proxmox_item.fields | selectattr('label', 'equalto', 'username') | first).value }}"
        proxmox_api_password: "{{ (onepassword_proxmox_item.fields | selectattr('label', 'equalto', 'password') | first).value }}"
      when: onepassword_enabled | default(false) | bool
      no_log: true

    # Option 2: Use Ansible Vault (default)
    - name: Load secrets from vault
      ansible.builtin.include_vars: ../../vars/common.vault.yaml
      when: not (onepassword_enabled | default(false) | bool)

    - name: Install multiple pip packages
      delegate_to: localhost
      ansible.builtin.pip:
        name:
          - bcrypt==4.3.0,jmespath==1.0.1,netaddr==1.3.0,passlib==1.7.4,proxmoxer==2.2.0
          - requests==2.32.3,botocore,boto3,pyvmomi,urllib3,PyYAML>=3.11,requests-oauthlib,pyVim,vmware-vcenter,vmware-vapi-common-client
  tasks:
    - name: Import Proxmox Role
      when: inventory_hostname == "pxm-baymx"
      ansible.builtin.include_role:
        name: ../../roles/proxmox
      vars:
        vm_name: omv-baymx
        mac_address: bc:24:11:e8:5f:c1
        cores: 16
        memory: 90480
        disk_size: 200
        storage_name: ssd-500
        proxmox_hostname: 'pxm-baymx'
        additional_disks:
          - /dev/disk/by-id/scsi-35000cca0bc75f620
          - /dev/disk/by-id/scsi-35000cca0bc6e0cc0
          - /dev/disk/by-id/scsi-35000cca097de6224
          - /dev/disk/by-id/scsi-35000cca0bc767184
          - /dev/disk/by-id/ata-CT500MX500SSD1_2325E6E669FD
