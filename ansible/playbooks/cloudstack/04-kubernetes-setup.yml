# CloudStack Kubernetes Service Setup Playbook
# Run this after CloudStack management server is installed
---
- name: Enable and Configure CloudStack Kubernetes Service
  hosts: localhost
  connection: local
  gather_facts: false
  vars_files:
    - ../../vars/common.vault.yml
  vars:
    # Network offering for Kubernetes clusters
    cloudstack_kubernetes_network_offering: "DefaultNetworkOfferingforKubernetesService"
    # Kubernetes versions to add (both architectures)
    # ISOs available at: http://download.cloudstack.org/cks/
    cloudstack_kubernetes_versions:
      - name: "v1.33.1-x86_64"
        semantic_version: "1.33.1"
        url: "http://download.cloudstack.org/cks/setup-v1.33.1-calico-x86_64.iso"
        zone_name: "Zone1"
        min_cpu: 2
        min_memory: 2048
      - name: "v1.33.1-aarch64"
        semantic_version: "1.33.1"
        url: "http://download.cloudstack.org/cks/setup-v1.33.1-calico-aarch64.iso"
        zone_name: "Zone1"
        min_cpu: 2
        min_memory: 2048
    # Enable experimental features (private docker registry support)
    cloudstack_kubernetes_experimental_features: false

  roles:
    - role: configure-kubernetes

  post_tasks:
    - name: Reminder to restart management server
      ansible.builtin.debug:
        msg: |
          ============================================
          CloudStack Kubernetes Service configured!
          ============================================

          IMPORTANT: Restart the management server to apply changes:

            ssh root@<management-server-ip> 'systemctl restart cloudstack-management'

          After restart, the Kubernetes tab will appear in the UI under Compute.

          To create a Kubernetes cluster:
          1. Go to Compute > Kubernetes
          2. Click "Add Kubernetes Cluster"
          3. Select zone, Kubernetes version, and configuration
          4. Click "OK" to create the cluster

          Kubernetes ISO download locations:
          - http://download.cloudstack.org/cks/
          - http://packages.shapeblue.com/cks/
