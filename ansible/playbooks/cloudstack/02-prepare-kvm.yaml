# Setup KVM hosts for CloudStack
---
- name: Setup CloudStack KVM Hypervisor Hosts
  hosts: cloudstack_kvm_hosts
  gather_facts: true
  become: true
  vars:
    ###############
    ## Prepare KVM Role Vars ##
    ###############
    prepare_kvm_version: '4.22'
    prepare_kvm_mgmt_interface: 'enp0s25'
    prepare_kvm_mgmt_domain: 'a113.internal'
    prepare_kvm_vfio_gpu_enabled: true

    # Additional NVMe storage for CloudStack local storage
    prepare_kvm_additional_storage:
      - device: '/dev/nvme1n1'
        mount_point: '/mnt/nvme1n1'
        filesystem: 'xfs'
        mount_options: 'noatime,nodiratime,discard'

  pre_tasks:
    # Option 1: Use 1Password (set onepassword_enabled=true)
    - name: Fetch KVM credentials from 1Password
      become: false
      onepassword.connect.item_info:
        vault: "{{ lookup('env', 'OP_VAULT') }}"
        item: "{{ onepassword_cloudstack_item | default('servers') }}"
      delegate_to: localhost
      register: onepassword_kvm_item
      when: onepassword_enabled | default(true) | bool
      no_log: true

    - name: Set KVM credentials from 1Password
      ansible.builtin.set_fact:
        prepare_kvm_root_password: '{{ onepassword_kvm_item.op_item.fields.password.value }}'
        ansible_password: '{{ onepassword_kvm_item.op_item.fields.password.value }}'
      when: onepassword_enabled | default(true) | bool
      no_log: true
  roles:
    - role: homelab.cloudstack.prepare_kvm
