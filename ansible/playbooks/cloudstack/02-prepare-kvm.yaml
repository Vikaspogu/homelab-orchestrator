# Setup KVM hosts for CloudStack
---
- name: Setup CloudStack KVM Hypervisor Hosts
  hosts: cloudstack_kvm_hosts
  become: true
  gather_facts: true
  vars:
    ###############
    ## Prepare KVM Role Vars ##
    ###############
    prepare_kvm_version: "4.22"
    prepare_kvm_mgmt_interface: "enp0s25"
    prepare_kvm_mgmt_domain: "a113.internal"
    prepare_kvm_vfio_gpu_enabled: true

    # Additional NVMe storage for CloudStack local storage
    prepare_kvm_additional_storage:
      - device: "/dev/nvme1n1"
        mount_point: "/mnt/nvme-storage"
        filesystem: "xfs"
        mount_options: "noatime,nodiratime,discard"

  pre_tasks:
    # Option 1: Use 1Password (set onepassword_enabled=true)
    - name: Fetch KVM credentials from 1Password
      onepassword.connect.item_info:
        vault: "{{ onepassword_vault }}"
        item: "{{ onepassword_item_kvm | default('cloudstack-kvm') }}"
      delegate_to: localhost
      register: onepassword_kvm_item
      when: onepassword_enabled | default(false) | bool
      no_log: true

    - name: Set KVM credentials from 1Password
      ansible.builtin.set_fact:
        prepare_kvm_root_password: "{{ (onepassword_kvm_item.fields | selectattr('label', 'equalto', 'root_password') | first).value }}"
        ansible_password: "{{ (onepassword_kvm_item.fields | selectattr('label', 'equalto', 'host_password') | first).value }}"
      when: onepassword_enabled | default(false) | bool
      no_log: true

    # Option 2: Use Ansible Vault (default)
    - name: Load secrets from vault
      ansible.builtin.include_vars: ../../vars/common.vault.yaml
      when: not (onepassword_enabled | default(false) | bool)
  roles:
    - role: homelab.cloudstack.prepare_kvm
