# CloudStack Management Server Deployment Playbook
---
- name: Deploy CloudStack Management Server with Database
  hosts: cloudstack_management
  become: true
  gather_facts: true
  vars:
    prepare_management_nfs_enabled: false
    prepare_management_version: "4.22"
  pre_tasks:
    # Option 1: Use 1Password (set onepassword_enabled=true)
    - name: Fetch database credentials from 1Password
      onepassword.connect.item_info:
        vault: "{{ onepassword_vault }}"
        item: "{{ onepassword_item_database | default('cloudstack-database') }}"
      delegate_to: localhost
      register: onepassword_database_item
      when: onepassword_enabled | default(false) | bool
      no_log: true

    - name: Set database credentials from 1Password
      ansible.builtin.set_fact:
        prepare_management_db_password: "{{ (onepassword_database_item.fields | selectattr('label', 'equalto', 'db_password') | first).value }}"
        prepare_management_server_key: "{{ (onepassword_database_item.fields | selectattr('label', 'equalto', 'server_key') | first).value }}"
        prepare_management_database_key: "{{ (onepassword_database_item.fields | selectattr('label', 'equalto', 'database_key') | first).value }}"
      when: onepassword_enabled | default(false) | bool
      no_log: true

    # Option 2: Use Ansible Vault (default)
    - name: Load secrets from vault
      ansible.builtin.include_vars: ../../vars/common.vault.yaml
      when: not (onepassword_enabled | default(false) | bool)
  roles:
    - role: homelab.cloudstack.prepare_management
