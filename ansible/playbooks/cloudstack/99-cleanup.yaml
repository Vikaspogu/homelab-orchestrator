---
- name: Cleanup CloudStack Management Server
  hosts: cloudstack_management
  become: true
  gather_facts: true
  tags:
    - management
    - mgmt

  vars:
    cleanup_confirm: true

  tasks:
    - name: Include cleanup role main tasks
      ansible.builtin.include_role:
        name: homelab.cloudstack.cleanup
        tasks_from: main.yaml

    - name: Run management server cleanup
      ansible.builtin.include_role:
        name: homelab.cloudstack.cleanup
        tasks_from: cleanup_management.yaml
      tags:
        - always

- name: Cleanup CloudStack KVM Hosts
  hosts: cloudstack_kvm_hosts
  become: true
  gather_facts: true
  tags:
    - kvm
    - hosts

  vars:
    cleanup_confirm: true
    cleanup_storage: true
    cleanup_libvirt: true
    cleanup_repo: true
    bridges_to_remove:
      - cloudbr0
      - cloudbr1

  tasks:
    - name: Include cleanup role main tasks
      ansible.builtin.include_role:
        name: homelab.cloudstack.cleanup
        tasks_from: main.yaml

    - name: Run KVM host cleanup
      ansible.builtin.include_role:
        name: homelab.cloudstack.cleanup
        tasks_from: cleanup_kvm_host.yaml
      tags:
        - always
