# Create Kubernetes Clusters via CloudStack CKS
# Uses CloudStack Kubernetes Service to create managed clusters
---
- name: Create CloudStack Kubernetes Clusters
  hosts: localhost
  connection: local
  gather_facts: false
  pre_tasks:
    # Option 1: Use 1Password (set onepassword_enabled=true)
    - name: Fetch CloudStack credentials from 1Password
      onepassword.connect.item_info:
        vault: "{{ onepassword_vault }}"
        item: "{{ onepassword_item_cloudstack | default('cloudstack-api') }}"
      delegate_to: localhost
      register: onepassword_cloudstack_item
      when: onepassword_enabled | default(false) | bool
      no_log: true

    - name: Set CloudStack credentials from 1Password
      ansible.builtin.set_fact:
        cloudstack_admin_password: "{{ (onepassword_cloudstack_item.fields | selectattr('label', 'equalto', 'admin_password') | first).value }}"
        cloudstack_api_url: "{{ (onepassword_cloudstack_item.fields | selectattr('label', 'equalto', 'api_url') | first).value | default('http://localhost:8080/client/api') }}"
      when: onepassword_enabled | default(false) | bool
      no_log: true

    # Option 2: Use Ansible Vault (default)
    - name: Load secrets from vault
      ansible.builtin.include_vars: ../../vars/common.vault.yaml
      when: not (onepassword_enabled | default(false) | bool)
  vars:
    ###############
    ## Kubernetes Cluster Role Vars ##
    ###############
    kubernetes_cluster_list:
      - name: "k8s-prod-1"
        description: "Production Kubernetes Cluster"
        zone: "Zone1"
        kubernetes_version: "v1.32.5-x86_64"
        service_offering: "CKS Instance"
        network: "guest-network"
        # template: "CKS-Ubuntu-22.04"  # Use CKS Ubuntu 22.04 for control/worker nodes
        enable_csi: true
        enable_gpu: true                # Enable GPU passthrough
        gpu_service_offering: "CKS Instance"  # GPU-enabled service offering
        size: 1
        control_nodes: 1
        node_root_disk_size: 50

    kubernetes_cluster_wait_for_cluster: true
    kubernetes_cluster_wait_timeout: 1800
  roles:
    - role: homelab.cloudstack.kubernetes_cluster

  post_tasks:
    - name: Display next steps
      ansible.builtin.debug:
        msg: |
          ============================================
          CloudStack Kubernetes Clusters Created!
          ============================================

          Kubeconfig files saved to:
          {% for cluster in kubernetes_cluster_list %}
            - kubeconfig-{{ cluster.name }}.yaml
          {% endfor %}

          To use a cluster:
            export KUBECONFIG=kubeconfig-{{ kubernetes_cluster_list[0].name }}.yaml
            kubectl get nodes
            kubectl get pods -A

          To access cluster via CloudStack:
            cloudmonkey list kubernetesclusters
            cloudmonkey get kubernetesclusterconfig id=<cluster-id>

          To scale cluster:
            cloudmonkey scale kubernetescluster id=<id> size=<new-size>

          To delete cluster:
            cloudmonkey delete kubernetescluster id=<id>
