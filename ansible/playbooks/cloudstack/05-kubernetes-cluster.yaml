---
- name: Create CloudStack Kubernetes Clusters
  hosts: localhost
  connection: local
  gather_facts: false
  pre_tasks:
    - name: Fetch CloudStack credentials from 1Password
      onepassword.connect.item_info:
        vault: "{{ lookup('env', 'OP_VAULT') }}"
        item: "{{ onepassword_item_cloudstack | default('cloudstack') }}"
      delegate_to: localhost
      register: onepassword_cloudstack_item
      when: onepassword_enabled | default(true) | bool
      no_log: true

    - name: Set CloudStack credentials from 1Password
      ansible.builtin.set_fact:
        cloudstack_admin_password: '{{ onepassword_cloudstack_item.op_item.fields.password.value }}'
        cloudstack_api_url: '{{ onepassword_cloudstack_item.op_item.fields.API_URL.value }}'
      when: onepassword_enabled | default(true) | bool
      no_log: true
  vars:
    kubernetes_cluster_list:
      - name: 'k8s-prod-1'
        description: 'Production Kubernetes Cluster'
        zone: 'Zone1'
        kubernetes_version: 'v1.32.5-x86_64'
        service_offering: 'CKS Instance'
        network: 'defaultGuestNetwork'
        enable_csi: false
        enable_gpu: false
        size: 2
        control_nodes: 1
        node_root_disk_size: 250

    kubernetes_cluster_wait_for_cluster: true
    kubernetes_cluster_wait_timeout: 1800
  roles:
    - role: homelab.cloudstack.kubernetes_cluster
