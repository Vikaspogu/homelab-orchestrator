# Install CloudStack Management Server
---
- name: Install CloudStack
  ansible.builtin.apt:
    name: '{{ prepare_management_cloudstack_packages }}'
    state: present
    update_cache: true

- name: Check Java version
  ansible.builtin.command: java -version
  register: prepare_management_java_version
  changed_when: false
  failed_when: false

- name: Ensure Java 17
  ansible.builtin.command: update-alternatives --set java /usr/lib/jvm/java-17-openjdk-amd64/bin/java
  when: "'17' not in (prepare_management_java_version.stderr | default(''))"
  failed_when: false
  changed_when: true

- name: Download vhd-util
  ansible.builtin.get_url:
    url: '{{ prepare_management_vhd_util_url }}'
    dest: /usr/share/cloudstack-common/scripts/vm/hypervisor/xenserver/vhd-util
    mode: '0755'
  when: prepare_management_xenserver_support

- name: Build database setup command
  ansible.builtin.set_fact:
    prepare_management_db_setup_cmd: >-
      cloudstack-setup-databases
      {{ prepare_management_db_user }}:{{ prepare_management_db_password }}@{{ prepare_management_db_host }}
      --deploy-as=root
      -e {{ prepare_management_encryption_type }}
      -m {{ prepare_management_server_key }}
      -k {{ prepare_management_database_key }}
      {% if prepare_management_server_ip %}-i {{ prepare_management_server_ip }}{% endif %}

- name: Check if database exists
  ansible.builtin.command: mysql -u root -e "SHOW DATABASES LIKE 'cloud';"
  register: prepare_management_cloud_db_check
  changed_when: false
  failed_when: false
  no_log: true

- name: Setup database
  ansible.builtin.command: '{{ prepare_management_db_setup_cmd }}'
  when: "'cloud' not in prepare_management_cloud_db_check.stdout"
  changed_when: true
  no_log: true

- name: Configure sudoers for cloud user
  ansible.builtin.lineinfile:
    path: /etc/sudoers.d/cloudstack
    line: 'Defaults:cloud !requiretty'
    create: true
    mode: '0440'
    validate: 'visudo -cf %s'
  when: cloudstack_kvm_on_management | default(false)

- name: Run cloudstack-setup-management
  ansible.builtin.command: cloudstack-setup-management
  register: prepare_management_mgmt_setup_result
  changed_when: "'CloudStack Management Server setup is done' in prepare_management_mgmt_setup_result.stdout | default('')"
  failed_when:
    - prepare_management_mgmt_setup_result.rc != 0
    - "'already' not in prepare_management_mgmt_setup_result.stderr | default('')"

- name: Enable CloudStack management
  ansible.builtin.systemd:
    name: cloudstack-management
    enabled: '{{ prepare_management_enable_services }}'
    state: "{{ 'started' if prepare_management_start_services else 'stopped' }}"
    daemon_reload: true

- name: Wait for management server
  ansible.builtin.uri:
    url: 'http://localhost:8080/client'
    method: GET
    status_code: [200, 302]
  register: prepare_management_mgmt_check
  until: prepare_management_mgmt_check.status in [200, 302]
  retries: 30
  delay: 10
  when: prepare_management_start_services
  failed_when: false
