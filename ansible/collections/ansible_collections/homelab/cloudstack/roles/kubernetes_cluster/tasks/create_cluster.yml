# Create a CloudStack Kubernetes cluster
---
- name: "{{ cluster.name }} - Validate required parameters"
  ansible.builtin.assert:
    that:
      - cluster.zone is defined
      - cluster.kubernetes_version is defined
      - cluster.service_offering is defined
      - _zone_ids[cluster.zone] is defined
      - _k8s_version_ids[cluster.kubernetes_version] is defined
      - _offering_ids[cluster.service_offering] is defined
    fail_msg: |
      Missing or invalid parameters for cluster {{ cluster.name }}:
      - Zone '{{ cluster.zone }}' ID: {{ _zone_ids[cluster.zone] | default('NOT FOUND') }}
      - K8s Version '{{ cluster.kubernetes_version }}' ID: {{ _k8s_version_ids[cluster.kubernetes_version] | default('NOT FOUND') }}
      - Service Offering '{{ cluster.service_offering }}' ID: {{ _offering_ids[cluster.service_offering] | default('NOT FOUND') }}

- name: "{{ cluster.name }} - Check if cluster exists"
  ansible.builtin.uri:
    url: "{{ cloudstack_api_url }}"
    method: POST
    body_format: form-urlencoded
    body:
      command: listKubernetesClusters
      name: "{{ cluster.name }}"
      response: json
      sessionkey: "{{ cloudstack_session_key }}"
    headers:
      Cookie: "{{ cloudstack_cookies }}"
    return_content: true
    timeout: "{{ kubernetes_api_timeout }}"
  register: existing_cluster

- name: "{{ cluster.name }} - Set cluster exists flag"
  ansible.builtin.set_fact:
    _cluster_exists: "{{ (existing_cluster.json.listkubernetesclustersresponse.kubernetescluster | default([]) | length) > 0 }}"

- name: "{{ cluster.name }} - Build create cluster parameters"
  ansible.builtin.set_fact:
    _create_params:
      command: createKubernetesCluster
      name: "{{ cluster.name }}"
      description: "{{ cluster.description | default(kubernetes_cluster_defaults.description) }}"
      zoneid: "{{ _zone_ids[cluster.zone] }}"
      kubernetesversionid: "{{ _k8s_version_ids[cluster.kubernetes_version] }}"
      serviceofferingid: "{{ _offering_ids[cluster.service_offering] }}"
      size: "{{ cluster.size | default(kubernetes_cluster_defaults.size) }}"
      controlnodes: "{{ cluster.control_nodes | default(kubernetes_cluster_defaults.control_nodes) }}"
      noderootdisksize: "{{ cluster.node_root_disk_size | default(kubernetes_cluster_defaults.node_root_disk_size) }}"
      response: json
      sessionkey: "{{ cloudstack_session_key }}"
  when: not _cluster_exists

- name: "{{ cluster.name }} - Add template if specified"
  ansible.builtin.set_fact:
    _create_params: "{{ _create_params | combine({'templateid': _template_ids[_cluster_template]}) }}"
  vars:
    _cluster_template: "{{ cluster.template | default(kubernetes_cluster_defaults.template) | default('') }}"
  when:
    - not _cluster_exists
    - _cluster_template | length > 0
    - _template_ids[_cluster_template] is defined

- name: "{{ cluster.name }} - Add network if specified"
  ansible.builtin.set_fact:
    _create_params: "{{ _create_params | combine({'networkid': _network_ids[cluster.network]}) }}"
  when:
    - not _cluster_exists
    - cluster.network is defined
    - cluster.network | length > 0
    - _network_ids[cluster.network] is defined

- name: "{{ cluster.name }} - Add external load balancer if specified"
  ansible.builtin.set_fact:
    _create_params: "{{ _create_params | combine({'externalloadbalanceripaddress': cluster.external_load_balancer}) }}"
  when:
    - not _cluster_exists
    - cluster.external_load_balancer is defined
    - cluster.external_load_balancer | length > 0

- name: "{{ cluster.name }} - Add docker registry if specified"
  ansible.builtin.set_fact:
    _create_params: "{{ _create_params | combine({
      'dockerregistryusername': cluster.docker_registry_username,
      'dockerregistrypassword': cluster.docker_registry_password,
      'dockerregistryurl': cluster.docker_registry_url
    }) }}"
  when:
    - not _cluster_exists
    - cluster.docker_registry_url is defined
    - cluster.docker_registry_url | length > 0
  no_log: true

- name: "{{ cluster.name }} - Create Kubernetes cluster"
  ansible.builtin.uri:
    url: "{{ cloudstack_api_url }}"
    method: POST
    body_format: form-urlencoded
    body: "{{ _create_params }}"
    headers:
      Cookie: "{{ cloudstack_cookies }}"
    return_content: true
    timeout: "{{ kubernetes_api_timeout }}"
  register: create_result
  when: not _cluster_exists

- name: "{{ cluster.name }} - Display creation result"
  ansible.builtin.debug:
    msg: |
      Cluster '{{ cluster.name }}' creation initiated.
      {% if create_result.json.createkubernetesclusterresponse.kubernetescluster is defined %}
      Cluster ID: {{ create_result.json.createkubernetesclusterresponse.kubernetescluster.id }}
      {% elif create_result.json.createkubernetesclusterresponse.jobid is defined %}
      Job ID: {{ create_result.json.createkubernetesclusterresponse.jobid }}
      {% endif %}
  when: not _cluster_exists and create_result is defined

- name: "{{ cluster.name }} - Cluster already exists"
  ansible.builtin.debug:
    msg: "Cluster '{{ cluster.name }}' already exists, skipping creation."
  when: _cluster_exists

