# Wait for Kubernetes cluster
---
- name: Get cluster status
  ansible.builtin.uri:
    url: '{{ cloudstack_api_url }}'
    method: POST
    body_format: form-urlencoded
    body:
      command: listKubernetesClusters
      name: '{{ cluster.name }}'
      response: json
      sessionkey: '{{ cloudstack_session_key }}'
    headers:
      Cookie: '{{ cloudstack_cookies }}'
    timeout: '{{ kubernetes_cluster_api_timeout }}'
  register: kubernetes_cluster_initial_status

- name: Set cluster state
  ansible.builtin.set_fact:
    kubernetes_cluster_state: "{{ kubernetes_cluster_initial_status.json.listkubernetesclustersresponse.kubernetescluster[0].state | default('Unknown') }}"
  when: kubernetes_cluster_initial_status.json.listkubernetesclustersresponse.kubernetescluster | default([]) | length > 0

- name: Fail if cluster errored
  ansible.builtin.fail:
    msg: "Cluster '{{ cluster.name }}' is in {{ kubernetes_cluster_state }} state"
  when:
    - kubernetes_cluster_state is defined
    - kubernetes_cluster_state in ['Error', 'Failed', 'Destroyed']

- name: Wait for cluster to be running
  ansible.builtin.uri:
    url: '{{ cloudstack_api_url }}'
    method: POST
    body_format: form-urlencoded
    body:
      command: listKubernetesClusters
      name: '{{ cluster.name }}'
      response: json
      sessionkey: '{{ cloudstack_session_key }}'
    headers:
      Cookie: '{{ cloudstack_cookies }}'
    timeout: '{{ kubernetes_cluster_api_timeout }}'
  register: kubernetes_cluster_status
  until: >
    (kubernetes_cluster_status.json.listkubernetesclustersresponse.kubernetescluster[0].state | default('Unknown')) in ['Running', 'Error', 'Failed', 'Destroyed']
  retries: '{{ (kubernetes_cluster_wait_timeout / 30) | int }}'
  delay: 30
  when:
    - kubernetes_cluster_state is defined
    - kubernetes_cluster_state in ['Starting', 'Created', 'Creating']

- name: Fail if cluster ended in error
  ansible.builtin.fail:
    msg: "Cluster '{{ cluster.name }}' provisioning failed"
  when:
    - kubernetes_cluster_status.json is defined
    - kubernetes_cluster_status.json.listkubernetesclustersresponse.kubernetescluster[0].state | default('') in ['Error', 'Failed', 'Destroyed']
