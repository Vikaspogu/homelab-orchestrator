# Register CKS-ready template for Kubernetes clusters
---
- name: List zones
  ngine_io.cloudstack.zone_info:
    api_url: "{{ cloudstack_api_url }}"
    api_key: "{{ cloudstack_api_key }}"
    api_secret: "{{ cloudstack_api_secret }}"
  register: kubernetes_cluster_zones_info_response

- name: Build zone ID map
  ansible.builtin.set_fact:
    kubernetes_cluster_zone_id_map: "{{ dict(kubernetes_cluster_zones_info_response.zones | default([]) | map(attribute='name') | zip(kubernetes_cluster_zones_info_response.zones | default([]) | map(attribute='id'))) }}"

- name: Check if template exists
  ansible.builtin.uri:
    url: "{{ cloudstack_api_url }}"
    method: POST
    body_format: form-urlencoded
    body:
      command: listTemplates
      templatefilter: all
      name: "{{ kubernetes_cluster_cks_template.name }}"
      zoneid: "{{ kubernetes_cluster_zone_id_map[kubernetes_cluster_cks_template.zone] }}"
      response: json
      sessionkey: "{{ cloudstack_session_key }}"
    headers:
      Cookie: "{{ cloudstack_cookies }}"
  register: kubernetes_cluster_template_check_response

- name: Set template exists flag
  ansible.builtin.set_fact:
    kubernetes_cluster_template_exists: "{{ (kubernetes_cluster_template_check_response.json.listtemplatesresponse.template | default([]) | length) > 0 }}"

- name: Register CKS-ready template
  ansible.builtin.uri:
    url: "{{ cloudstack_api_url }}"
    method: POST
    body_format: form-urlencoded
    body:
      command: registerTemplate
      name: "{{ kubernetes_cluster_cks_template.name }}"
      displaytext: "{{ kubernetes_cluster_cks_template.display_text | default(kubernetes_cluster_cks_template.name) }}"
      url: "{{ kubernetes_cluster_cks_template.url }}"
      format: "{{ kubernetes_cluster_cks_template.format | default('QCOW2') }}"
      hypervisor: "{{ kubernetes_cluster_cks_template.hypervisor | default('KVM') }}"
      ostypeid: "{{ kubernetes_cluster_ostype_id }}"
      zoneid: "{{ kubernetes_cluster_zone_id_map[kubernetes_cluster_cks_template.zone] }}"
      ispublic: "{{ kubernetes_cluster_cks_template.is_public | default(true) | lower }}"
      isfeatured: "true"
      passwordenabled: "{{ kubernetes_cluster_cks_template.password_enabled | default(false) | lower }}"
      sshkeyenabled: "{{ kubernetes_cluster_cks_template.sshkey_enabled | default(true) | lower }}"
      isdynamicallyscalable: "true"
      directdownload: "true"
      hvm: "true"
      requireshvm: "true"
      forcks: "true"
      response: json
      sessionkey: "{{ cloudstack_session_key }}"
    headers:
      Cookie: "{{ cloudstack_cookies }}"
  register: kubernetes_cluster_register_template_result
  when: not kubernetes_cluster_template_exists
  failed_when: >
    kubernetes_cluster_register_template_result is failed and
    'already exists' not in (kubernetes_cluster_register_template_result.content | default(''))

- name: Wait for template to be ready  # noqa: no-handler
  ansible.builtin.uri:
    url: "{{ cloudstack_api_url }}"
    method: POST
    body_format: form-urlencoded
    body:
      command: listTemplates
      templatefilter: all
      name: "{{ kubernetes_cluster_cks_template.name }}"
      zoneid: "{{ kubernetes_cluster_zone_id_map[kubernetes_cluster_cks_template.zone] }}"
      response: json
      sessionkey: "{{ cloudstack_session_key }}"
    headers:
      Cookie: "{{ cloudstack_cookies }}"
  register: kubernetes_cluster_template_status
  until: >
    (kubernetes_cluster_template_status.json.listtemplatesresponse.template | default([]) | length) > 0 and
    (kubernetes_cluster_template_status.json.listtemplatesresponse.template[0].isready | default(false))
  retries: 60
  delay: 30
  when: kubernetes_cluster_register_template_result.changed | default(false)
