# Create a CloudStack Kubernetes cluster
---
- name: Validate required parameters
  ansible.builtin.assert:
    that:
      - cluster.zone is defined
      - cluster.kubernetes_version is defined
      - cluster.service_offering is defined
      - kubernetes_cluster_zone_ids[cluster.zone] is defined
      - kubernetes_cluster_k8s_version_ids[cluster.kubernetes_version] is defined
      - kubernetes_cluster_offering_ids[cluster.service_offering] is defined
    fail_msg: "Missing or invalid parameters for cluster {{ cluster.name }}"

- name: Check if cluster exists
  ansible.builtin.uri:
    url: "{{ cloudstack_api_url }}"
    method: POST
    body_format: form-urlencoded
    body:
      command: listKubernetesClusters
      name: "{{ cluster.name }}"
      response: json
      sessionkey: "{{ cloudstack_session_key }}"
    headers:
      Cookie: "{{ cloudstack_cookies }}"
    timeout: "{{ kubernetes_cluster_api_timeout }}"
  register: kubernetes_cluster_existing

- name: Set cluster exists flag
  ansible.builtin.set_fact:
    kubernetes_cluster_exists: "{{ (kubernetes_cluster_existing.json.listkubernetesclustersresponse.kubernetescluster | default([]) | length) > 0 }}"

- name: Configure cluster creation
  when: not kubernetes_cluster_exists
  block:
    - name: Determine service offering
      ansible.builtin.set_fact:
        kubernetes_cluster_effective_offering: >-
          {{ cluster.gpu_service_offering
             if (cluster.enable_gpu | default(false) and cluster.gpu_service_offering is defined)
             else cluster.service_offering }}

    - name: Build create cluster parameters
      ansible.builtin.set_fact:
        kubernetes_cluster_create_params:
          command: createKubernetesCluster
          name: "{{ cluster.name }}"
          description: "{{ cluster.description | default(kubernetes_cluster_defaults.description) }}"
          zoneid: "{{ kubernetes_cluster_zone_ids[cluster.zone] }}"
          kubernetesversionid: "{{ kubernetes_cluster_k8s_version_ids[cluster.kubernetes_version] }}"
          serviceofferingid: "{{ kubernetes_cluster_offering_ids[kubernetes_cluster_effective_offering] }}"
          size: "{{ cluster.size | default(kubernetes_cluster_defaults.size) }}"
          controlnodes: "{{ cluster.control_nodes | default(kubernetes_cluster_defaults.control_nodes) }}"
          noderootdisksize: "{{ cluster.node_root_disk_size | default(kubernetes_cluster_defaults.node_root_disk_size) }}"
          response: json
          sessionkey: "{{ cloudstack_session_key }}"

    - name: Set CKS template name
      ansible.builtin.set_fact:
        kubernetes_cluster_template: "{{ cluster.template | default(kubernetes_cluster_defaults.template) | default('') }}"

    - name: Validate custom template exists
      ansible.builtin.assert:
        that:
          - kubernetes_cluster_template_ids[kubernetes_cluster_template] is defined
        fail_msg: "Template '{{ kubernetes_cluster_template }}' not found"
      when: kubernetes_cluster_template | length > 0

    - name: Add custom template
      ansible.builtin.set_fact:
        kubernetes_cluster_create_params: "{{ kubernetes_cluster_create_params | combine({'templateid': kubernetes_cluster_template_ids[kubernetes_cluster_template]}) }}"
      when:
        - kubernetes_cluster_template | length > 0
        - kubernetes_cluster_template_ids[kubernetes_cluster_template] is defined

    - name: Enable CSI driver
      ansible.builtin.set_fact:
        kubernetes_cluster_create_params: "{{ kubernetes_cluster_create_params | combine({'csi': 'true'}) }}"
      when: cluster.enable_csi | default(kubernetes_cluster_defaults.enable_csi) | default(true) | bool

    - name: Add network if specified
      ansible.builtin.set_fact:
        kubernetes_cluster_create_params: "{{ kubernetes_cluster_create_params | combine({'networkid': kubernetes_cluster_network_ids[cluster.network]}) }}"
      when:
        - cluster.network is defined
        - kubernetes_cluster_network_ids[cluster.network] is defined

    - name: Add external load balancer
      ansible.builtin.set_fact:
        kubernetes_cluster_create_params: "{{ kubernetes_cluster_create_params | combine({'externalloadbalanceripaddress': cluster.external_load_balancer}) }}"
      when: cluster.external_load_balancer | default('') | length > 0

    - name: Add docker registry
      ansible.builtin.set_fact:
        kubernetes_cluster_create_params: >-
          {{ kubernetes_cluster_create_params | combine({
            'dockerregistryusername': cluster.docker_registry_username,
            'dockerregistrypassword': cluster.docker_registry_password,
            'dockerregistryurl': cluster.docker_registry_url
          }) }}
      when: cluster.docker_registry_url | default('') | length > 0
      no_log: true

    - name: Create Kubernetes cluster
      ansible.builtin.uri:
        url: "{{ cloudstack_api_url }}"
        method: POST
        body_format: form-urlencoded
        body: "{{ kubernetes_cluster_create_params }}"
        headers:
          Cookie: "{{ cloudstack_cookies }}"
        timeout: "{{ kubernetes_cluster_api_timeout }}"
      register: kubernetes_cluster_create_result
