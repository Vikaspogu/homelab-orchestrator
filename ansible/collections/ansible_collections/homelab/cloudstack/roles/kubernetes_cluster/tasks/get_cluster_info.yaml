# Get Kubernetes cluster information
---
- name: Get all clusters
  ansible.builtin.uri:
    url: "{{ cloudstack_api_url }}"
    method: POST
    body_format: form-urlencoded
    body:
      command: listKubernetesClusters
      response: json
      sessionkey: "{{ cloudstack_session_key }}"
    headers:
      Cookie: "{{ cloudstack_cookies }}"
    timeout: "{{ kubernetes_cluster_api_timeout }}"
  register: kubernetes_cluster_all_clusters

- name: Build cluster maps
  ansible.builtin.set_fact:
    kubernetes_cluster_states: "{{ dict(kubernetes_cluster_all_clusters.json.listkubernetesclustersresponse.kubernetescluster | default([]) | map(attribute='name') | zip(kubernetes_cluster_all_clusters.json.listkubernetesclustersresponse.kubernetescluster | default([]) | map(attribute='state'))) }}"
    kubernetes_cluster_endpoints: "{{ dict(kubernetes_cluster_all_clusters.json.listkubernetesclustersresponse.kubernetescluster | default([]) | map(attribute='name') | zip(kubernetes_cluster_all_clusters.json.listkubernetesclustersresponse.kubernetescluster | default([]) | map(attribute='endpoint', default=''))) }}"
    kubernetes_cluster_ids: "{{ dict(kubernetes_cluster_all_clusters.json.listkubernetesclustersresponse.kubernetescluster | default([]) | map(attribute='name') | zip(kubernetes_cluster_all_clusters.json.listkubernetesclustersresponse.kubernetescluster | default([]) | map(attribute='id'))) }}"

- name: Get kubeconfig for running clusters
  ansible.builtin.uri:
    url: "{{ cloudstack_api_url }}"
    method: POST
    body_format: form-urlencoded
    body:
      command: getKubernetesClusterConfig
      id: "{{ kubernetes_cluster_ids[cluster.name] }}"
      response: json
      sessionkey: "{{ cloudstack_session_key }}"
    headers:
      Cookie: "{{ cloudstack_cookies }}"
    timeout: "{{ kubernetes_cluster_api_timeout }}"
  register: kubernetes_cluster_kubeconfig_result
  loop: "{{ kubernetes_cluster_list }}"
  loop_control:
    loop_var: cluster
    label: "{{ cluster.name }}"
  when:
    - kubernetes_cluster_ids[cluster.name] is defined
    - kubernetes_cluster_states[cluster.name] | default('') == 'Running'
  failed_when: false

- name: Save kubeconfig files
  ansible.builtin.copy:
    content: "{{ item.json.getkubernetesclusterconfigresponse.clusterconfig.configdata }}"
    dest: "{{ playbook_dir }}/../kubeconfig-{{ item.cluster.name }}.yaml"
    mode: "0600"
  loop: "{{ kubernetes_cluster_kubeconfig_result.results | default([]) }}"
  loop_control:
    label: "{{ item.cluster.name }}"
  when: item.json.getkubernetesclusterconfigresponse.clusterconfig.configdata is defined
  delegate_to: localhost
