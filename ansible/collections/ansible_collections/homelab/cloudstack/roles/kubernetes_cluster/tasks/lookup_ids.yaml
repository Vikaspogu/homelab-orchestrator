# Lookup CloudStack resource IDs by name
---
- name: Get all zones
  ansible.builtin.uri:
    url: "{{ cloudstack_api_url }}"
    method: POST
    body_format: form-urlencoded
    body:
      command: listZones
      response: json
      sessionkey: "{{ cloudstack_session_key }}"
    headers:
      Cookie: "{{ cloudstack_cookies }}"
    return_content: true
    timeout: "{{ kubernetes_cluster_api_timeout }}"
  register: kubernetes_cluster_zones_response

- name: Build zone ID map
  ansible.builtin.set_fact:
    kubernetes_cluster_zone_ids: "{{ kubernetes_cluster_zone_ids | default({}) | combine({item.name: item.id}) }}"
  loop: "{{ kubernetes_cluster_zones_response.json.listzonesresponse.zone | default([]) }}"

- name: Get all service offerings
  ansible.builtin.uri:
    url: "{{ cloudstack_api_url }}"
    method: POST
    body_format: form-urlencoded
    body:
      command: listServiceOfferings
      response: json
      sessionkey: "{{ cloudstack_session_key }}"
    headers:
      Cookie: "{{ cloudstack_cookies }}"
    return_content: true
    timeout: "{{ kubernetes_cluster_api_timeout }}"
  register: kubernetes_cluster_offerings_response

- name: Build service offering ID map
  ansible.builtin.set_fact:
    kubernetes_cluster_offering_ids: "{{ kubernetes_cluster_offering_ids | default({}) | combine({item.name: item.id}) }}"
  loop: "{{ kubernetes_cluster_offerings_response.json.listserviceofferingsresponse.serviceoffering | default([]) }}"

- name: Get Kubernetes supported versions
  ansible.builtin.uri:
    url: "{{ cloudstack_api_url }}"
    method: POST
    body_format: form-urlencoded
    body:
      command: listKubernetesSupportedVersions
      response: json
      sessionkey: "{{ cloudstack_session_key }}"
    headers:
      Cookie: "{{ cloudstack_cookies }}"
    return_content: true
    timeout: "{{ kubernetes_cluster_api_timeout }}"
  register: kubernetes_cluster_versions_response

- name: Build Kubernetes version ID map
  ansible.builtin.set_fact:
    kubernetes_cluster_k8s_version_ids: "{{ kubernetes_cluster_k8s_version_ids | default({}) | combine({item.name: item.id}) }}"
  loop: "{{ kubernetes_cluster_versions_response.json.listkubernetessupportedversionsresponse.kubernetessupportedversion | default([]) }}"

- name: Get all networks
  ansible.builtin.uri:
    url: "{{ cloudstack_api_url }}"
    method: POST
    body_format: form-urlencoded
    body:
      command: listNetworks
      response: json
      sessionkey: "{{ cloudstack_session_key }}"
    headers:
      Cookie: "{{ cloudstack_cookies }}"
    return_content: true
    timeout: "{{ kubernetes_cluster_api_timeout }}"
  register: kubernetes_cluster_networks_response

- name: Build network ID map
  ansible.builtin.set_fact:
    kubernetes_cluster_network_ids: "{{ kubernetes_cluster_network_ids | default({}) | combine({item.name: item.id}) }}"
  loop: "{{ kubernetes_cluster_networks_response.json.listnetworksresponse.network | default([]) }}"

- name: Get OS types
  ansible.builtin.uri:
    url: "{{ cloudstack_api_url }}"
    method: POST
    body_format: form-urlencoded
    body:
      command: listOsTypes
      description: "{{ kubernetes_cluster_cks_template.os_type | default('Ubuntu 22.04') }}"
      response: json
      sessionkey: "{{ cloudstack_session_key }}"
    headers:
      Cookie: "{{ cloudstack_cookies }}"
    return_content: true
    timeout: "{{ kubernetes_cluster_api_timeout }}"
  register: kubernetes_cluster_ostypes_response
  when: kubernetes_cluster_cks_template.name | default('') | length > 0

- name: Set OS type ID
  ansible.builtin.set_fact:
    kubernetes_cluster_ostype_id: "{{ kubernetes_cluster_ostypes_response.json.listostypesresponse.ostype[0].id }}"
  when:
    - kubernetes_cluster_cks_template.name | default('') | length > 0
    - kubernetes_cluster_ostypes_response.json.listostypesresponse.ostype | default([]) | length > 0

- name: Get all templates
  ansible.builtin.uri:
    url: "{{ cloudstack_api_url }}"
    method: POST
    body_format: form-urlencoded
    body:
      command: listTemplates
      templatefilter: all
      response: json
      sessionkey: "{{ cloudstack_session_key }}"
    headers:
      Cookie: "{{ cloudstack_cookies }}"
    return_content: true
    timeout: "{{ kubernetes_cluster_api_timeout }}"
  register: kubernetes_cluster_templates_response

- name: Build template ID map
  ansible.builtin.set_fact:
    kubernetes_cluster_template_ids: "{{ kubernetes_cluster_template_ids | default({}) | combine({item.name: item.id}) }}"
  loop: "{{ kubernetes_cluster_templates_response.json.listtemplatesresponse.template | default([]) }}"

- name: Display available resources
  ansible.builtin.debug:
    msg: |
      Available CloudStack Resources:

      Zones: {{ kubernetes_cluster_zone_ids.keys() | list | join(', ') }}
      Service Offerings: {{ kubernetes_cluster_offering_ids.keys() | list | join(', ') }}
      Kubernetes Versions: {{ kubernetes_cluster_k8s_version_ids.keys() | list | join(', ') }}
      Networks: {{ kubernetes_cluster_network_ids.keys() | list | join(', ') }}
      Templates: {{ kubernetes_cluster_template_ids.keys() | list | join(', ') }}
  when: kubernetes_cluster_zone_ids is defined
