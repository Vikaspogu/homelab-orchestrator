# Lookup CloudStack resource IDs
---
- name: Get zones
  ngine_io.cloudstack.zone_info:
    api_url: "{{ cloudstack_api_url }}"
    api_key: "{{ cloudstack_api_key }}"
    api_secret: "{{ cloudstack_api_secret }}"
  register: kubernetes_cluster_zones_response

- name: Build zone ID map
  ansible.builtin.set_fact:
    kubernetes_cluster_zone_ids: "{{ dict(kubernetes_cluster_zones_response.zones | default([]) | map(attribute='name') | zip(kubernetes_cluster_zones_response.zones | default([]) | map(attribute='id'))) }}"

- name: Get service offerings
  ansible.builtin.uri:
    url: "{{ cloudstack_api_url }}"
    method: POST
    body_format: form-urlencoded
    body:
      command: listServiceOfferings
      response: json
      sessionkey: "{{ cloudstack_session_key }}"
    headers:
      Cookie: "{{ cloudstack_cookies }}"
    timeout: "{{ kubernetes_cluster_api_timeout }}"
  register: kubernetes_cluster_offerings_response

- name: Build offering ID map
  ansible.builtin.set_fact:
    kubernetes_cluster_offering_ids: "{{ dict(kubernetes_cluster_offerings_response.json.listserviceofferingsresponse.serviceoffering | default([]) | map(attribute='name') | zip(kubernetes_cluster_offerings_response.json.listserviceofferingsresponse.serviceoffering | default([]) | map(attribute='id'))) }}"

- name: Get Kubernetes versions
  ansible.builtin.uri:
    url: "{{ cloudstack_api_url }}"
    method: POST
    body_format: form-urlencoded
    body:
      command: listKubernetesSupportedVersions
      response: json
      sessionkey: "{{ cloudstack_session_key }}"
    headers:
      Cookie: "{{ cloudstack_cookies }}"
    timeout: "{{ kubernetes_cluster_api_timeout }}"
  register: kubernetes_cluster_versions_response

- name: Build version ID map
  ansible.builtin.set_fact:
    kubernetes_cluster_k8s_version_ids: "{{ dict(kubernetes_cluster_versions_response.json.listkubernetessupportedversionsresponse.kubernetessupportedversion | default([]) | map(attribute='name') | zip(kubernetes_cluster_versions_response.json.listkubernetessupportedversionsresponse.kubernetessupportedversion | default([]) | map(attribute='id'))) }}"

- name: Get networks
  ansible.builtin.uri:
    url: "{{ cloudstack_api_url }}"
    method: POST
    body_format: form-urlencoded
    body:
      command: listNetworks
      response: json
      sessionkey: "{{ cloudstack_session_key }}"
    headers:
      Cookie: "{{ cloudstack_cookies }}"
    timeout: "{{ kubernetes_cluster_api_timeout }}"
  register: kubernetes_cluster_networks_response

- name: Build network ID map
  ansible.builtin.set_fact:
    kubernetes_cluster_network_ids: "{{ dict(kubernetes_cluster_networks_response.json.listnetworksresponse.network | default([]) | map(attribute='name') | zip(kubernetes_cluster_networks_response.json.listnetworksresponse.network | default([]) | map(attribute='id'))) }}"

- name: Get OS types
  ansible.builtin.uri:
    url: "{{ cloudstack_api_url }}"
    method: POST
    body_format: form-urlencoded
    body:
      command: listOsTypes
      description: "{{ kubernetes_cluster_cks_template.os_type | default('Ubuntu 22.04') }}"
      response: json
      sessionkey: "{{ cloudstack_session_key }}"
    headers:
      Cookie: "{{ cloudstack_cookies }}"
    timeout: "{{ kubernetes_cluster_api_timeout }}"
  register: kubernetes_cluster_ostypes_response
  when: kubernetes_cluster_cks_template.name | default('') | length > 0

- name: Set OS type ID
  ansible.builtin.set_fact:
    kubernetes_cluster_ostype_id: "{{ kubernetes_cluster_ostypes_response.json.listostypesresponse.ostype[0].id }}"
  when:
    - kubernetes_cluster_cks_template.name | default('') | length > 0
    - kubernetes_cluster_ostypes_response.json.listostypesresponse.ostype | default([]) | length > 0

- name: Get templates
  ansible.builtin.uri:
    url: "{{ cloudstack_api_url }}"
    method: POST
    body_format: form-urlencoded
    body:
      command: listTemplates
      templatefilter: all
      response: json
      sessionkey: "{{ cloudstack_session_key }}"
    headers:
      Cookie: "{{ cloudstack_cookies }}"
    timeout: "{{ kubernetes_cluster_api_timeout }}"
  register: kubernetes_cluster_templates_response

- name: Build template ID map
  ansible.builtin.set_fact:
    kubernetes_cluster_template_ids: "{{ dict(kubernetes_cluster_templates_response.json.listtemplatesresponse.template | default([]) | map(attribute='name') | zip(kubernetes_cluster_templates_response.json.listtemplatesresponse.template | default([]) | map(attribute='id'))) }}"
