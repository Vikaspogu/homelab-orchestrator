# Configure Zone Role - Main Tasks
# Sets up CloudStack zone infrastructure: zone, networks, pods, clusters, storage
---
- name: Validate required variables
  ansible.builtin.assert:
    that:
      - cloudstack_api_url is defined
    fail_msg: 'Required CloudStack API configuration variables are not set'

- name: Get CloudStack API authentication
  ansible.builtin.include_role:
    name: homelab.cloudstack.api_auth
  when: cloudstack_session_key is not defined

# Zone creation
- name: Create Zone
  ansible.builtin.import_tasks: create_zone.yaml
  when: configure_zone_zone is defined
  tags:
    - zone

# Physical networks
- name: Create Physical Networks
  ansible.builtin.import_tasks: create_physical_networks.yaml
  when: configure_zone_physical_networks | default([]) | length > 0
  tags:
    - network
    - physical

# Pods
- name: Create Pods
  ansible.builtin.import_tasks: create_pods.yaml
  when: configure_zone_pods | default([]) | length > 0
  tags:
    - pods

# Clusters
- name: Create Clusters
  ansible.builtin.import_tasks: create_clusters.yaml
  when: configure_zone_clusters | default([]) | length > 0
  tags:
    - clusters

# IP Ranges
- name: Configure Storage and Public IP Ranges
  ansible.builtin.import_tasks: configure_ip_ranges.yaml
  when: >
    (configure_zone_storage_ip_ranges | default([]) | length > 0) or
    (configure_zone_public_ip_ranges | default([]) | length > 0)
  tags:
    - ip_ranges

# Guest Networks
- name: Create Guest Networks
  ansible.builtin.import_tasks: create_guest_networks.yaml
  when: configure_zone_guest_ip_ranges | default([]) | length > 0
  tags:
    - guest_networks

# Secondary Storage
- name: Configure Secondary Storage
  ansible.builtin.import_tasks: configure_secondary_storage.yaml
  when: configure_zone_secondary_storage.url is defined
  tags:
    - storage
    - secondary

# SystemVM Template (register after secondary storage is configured)
- name: Register SystemVM Template
  ansible.builtin.import_tasks: register_systemvm_template.yaml
  when: configure_zone_systemvm_template is defined
  tags:
    - template
    - systemvm

# Enable Zone
- name: Enable Zone
  ansible.builtin.import_tasks: enable_zone.yaml
  when: configure_zone_zone is defined
  tags:
    - zone
    - enable
