# Configure firewall for CloudStack KVM hosts
# Based on CloudStack documentation requirements
---
# UFW forward policy must be ACCEPT on Ubuntu 22.04+
- name: Check if UFW is installed
  ansible.builtin.stat:
    path: /usr/sbin/ufw
  register: prepare_hosts_ufw_installed

- name: Configure UFW default forward policy to ACCEPT
  ansible.builtin.lineinfile:
    path: /etc/default/ufw
    regexp: '^DEFAULT_FORWARD_POLICY='
    line: 'DEFAULT_FORWARD_POLICY="ACCEPT"'
    state: present
  when: prepare_hosts_ufw_installed.stat.exists
  notify: Reload UFW

- name: Open CloudStack required ports in UFW
  community.general.ufw:
    rule: allow
    port: '{{ item.port }}'
    proto: tcp
    comment: '{{ item.comment }}'
  loop:
    - { port: '22', comment: 'SSH' }
    - { port: '1798', comment: 'CloudStack Agent' }
    - { port: '16514', comment: 'Libvirt TLS' }
    - { port: '16509', comment: 'Libvirt TCP' }
    - { port: '5900:6100', comment: 'VNC Consoles' }
    - { port: '49152:49216', comment: 'Libvirt Live Migration' }
  when:
    - prepare_hosts_ufw_installed.stat.exists
    - prepare_hosts_configure_firewall | default(true)
  failed_when: false
