# Create a single Physical Network
---
- name: Check if physical network exists
  ansible.builtin.set_fact:
    cloudstack_ops_network_exists: >-
      {{ cloudstack_ops_existing_networks | selectattr('name', 'defined') |
         selectattr('name', 'equalto', physical_network.name) | list | length > 0 }}

- name: Get existing physical network ID
  ansible.builtin.set_fact:
    cloudstack_ops_physical_network_id: "{{ (cloudstack_ops_existing_networks | selectattr('name', 'equalto', physical_network.name) | first).id }}"
  when: cloudstack_ops_network_exists

- name: Create physical network
  ngine_io.cloudstack.physical_network:
    api_url: "{{ cloudstack_api_url }}"
    api_key: "{{ cloudstack_api_key }}"
    api_secret: "{{ cloudstack_api_secret }}"
    name: "{{ physical_network.name }}"
    zone: "{{ cloudstack_ops_zone.name }}"
    isolation_method: "{{ physical_network.isolation_method | default('VLAN') }}"
    vlan: "{{ physical_network.vlan_range | default(omit) }}"
    state: present
    api_timeout: 300
  register: cloudstack_ops_physical_network_result
  when: not cloudstack_ops_network_exists

- name: Set physical network ID from creation
  ansible.builtin.set_fact:
    cloudstack_ops_physical_network_id: "{{ cloudstack_ops_physical_network_result.id }}"
  when: not cloudstack_ops_network_exists and cloudstack_ops_physical_network_result.id is defined

- name: Add traffic types to physical network
  ngine_io.cloudstack.traffic_type:
    api_url: "{{ cloudstack_api_url }}"
    api_key: "{{ cloudstack_api_key }}"
    api_secret: "{{ cloudstack_api_secret }}"
    physical_network: "{{ physical_network.name }}"
    zone: "{{ cloudstack_ops_zone.name }}"
    traffic_type: "{{ traffic_type.type }}"
    kvm_networklabel: "{{ traffic_type.label }}"
    state: present
    api_timeout: 300
  loop: "{{ physical_network.traffic_types }}"
  loop_control:
    loop_var: traffic_type
  register: cloudstack_ops_traffic_type_result
  failed_when: false

- name: Display traffic type results
  ansible.builtin.debug:
    msg: "Traffic type '{{ item.traffic_type.type }}' - {{ 'configured' if not item.failed else 'already exists or skipped' }}"
  loop: "{{ cloudstack_ops_traffic_type_result.results }}"
  when: cloudstack_ops_traffic_type_result.results is defined

- name: Enable physical network with service providers
  ngine_io.cloudstack.physical_network:
    api_url: "{{ cloudstack_api_url }}"
    api_key: "{{ cloudstack_api_key }}"
    api_secret: "{{ cloudstack_api_secret }}"
    name: "{{ physical_network.name }}"
    zone: "{{ cloudstack_ops_zone.name }}"
    nsps_enabled:
      - VirtualRouter
      - SecurityGroupProvider
    state: enabled
    api_timeout: 300

- name: Display physical network info
  ansible.builtin.debug:
    msg: "Physical network '{{ physical_network.name }}' configured and enabled"
