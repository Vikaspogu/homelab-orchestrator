# Add KVM Hosts to CloudStack
---
- name: Add KVM hosts to clusters
  ngine_io.cloudstack.host:
    api_url: "{{ cloudstack_api_url }}"
    api_key: "{{ cloudstack_api_key }}"
    api_secret: "{{ cloudstack_api_secret }}"
    name: "{{ host.hostname }}"
    zone: "{{ cloudstack_ops_zone.name }}"
    pod: "{{ host.pod_name | default(cloudstack_ops_pods[0].name) }}"
    cluster: "{{ host.cluster_name }}"
    hypervisor: "KVM"
    username: "{{ host.username | default(ansible_user) }}"
    password: "{{ host.password | default(ansible_password) }}"
    url: "http://{{ host.hostname }}"
    state: present
    api_timeout: 300
  loop: "{{ cloudstack_ops_hosts }}"
  loop_control:
    loop_var: host
  register: cloudstack_ops_hosts_result
  no_log: true

- name: Display host information
  ansible.builtin.debug:
    msg: "Host '{{ item.host.hostname }}' {{ 'added' if item.changed else 'already exists' }}"
  loop: "{{ cloudstack_ops_hosts_result.results }}"
  loop_control:
    label: "{{ item.host.hostname }}"
  when: cloudstack_ops_hosts_result.results is defined

# Filter hosts that need tagging
- name: Identify hosts requiring tag updates
  ansible.builtin.set_fact:
    cloudstack_ops_hosts_to_tag: "{{ cloudstack_ops_hosts | selectattr('host_tags', 'defined') | list }}"

- name: Debug hosts to tag
  ansible.builtin.debug:
    msg: "Hosts to tag: {{ cloudstack_ops_hosts_to_tag | map(attribute='hostname') | list }}"
  when: cloudstack_ops_hosts_to_tag | length > 0

# Get host IDs for tagging
- name: Get host details for tagging
  ansible.builtin.uri:
    url: "{{ cloudstack_api_url }}"
    method: POST
    body_format: form-urlencoded
    body:
      command: listHosts
      name: "{{ host_to_tag.hostname }}"
      type: Routing
      response: json
      sessionkey: "{{ cloudstack_session_key }}"
    headers:
      Cookie: "{{ cloudstack_cookies }}"
    return_content: true
    timeout: "{{ cloudstack_ops_async_timeout }}"
  loop: "{{ cloudstack_ops_hosts_to_tag }}"
  loop_control:
    loop_var: host_to_tag
    label: "{{ host_to_tag.hostname }}"
  register: cloudstack_ops_host_details
  when: cloudstack_ops_hosts_to_tag | length > 0

- name: Debug host details response
  ansible.builtin.debug:
    msg: |
      Host: {{ item.host_to_tag.hostname }}
      Found: {{ item.json.listhostsresponse.host | default([]) | length > 0 }}
      Host ID: {{ item.json.listhostsresponse.host[0].id | default('N/A') }}
      Current tags: {{ item.json.listhostsresponse.host[0].hosttags | default('none') }}
      Desired tags: {{ item.host_to_tag.host_tags }}
  loop: "{{ cloudstack_ops_host_details.results | default([]) }}"
  loop_control:
    label: "{{ item.host_to_tag.hostname | default('N/A') }}"
  when:
    - cloudstack_ops_host_details.results is defined
    - item.json is defined
    - item.json.listhostsresponse.host is defined

- name: Update host tags
  ansible.builtin.uri:
    url: "{{ cloudstack_api_url }}"
    method: POST
    body_format: form-urlencoded
    body:
      command: updateHost
      id: "{{ item.json.listhostsresponse.host[0].id }}"
      hosttags: "{{ item.host_to_tag.host_tags }}"
      response: json
      sessionkey: "{{ cloudstack_session_key }}"
    headers:
      Cookie: "{{ cloudstack_cookies }}"
    return_content: true
    timeout: "{{ cloudstack_ops_async_timeout }}"
  loop: "{{ cloudstack_ops_host_details.results | default([]) }}"
  loop_control:
    label: "{{ item.host_to_tag.hostname | default('N/A') }}"
  register: cloudstack_ops_host_tags_result
  when:
    - item.json is defined
    - item.json.listhostsresponse is defined
    - item.json.listhostsresponse.host is defined
    - item.json.listhostsresponse.host | length > 0
    - item.host_to_tag.host_tags is defined
    - item.host_to_tag.host_tags | length > 0

- name: Display host tag update results
  ansible.builtin.debug:
    msg: "Host '{{ item.item.host_to_tag.hostname }}' tags updated to: {{ item.item.host_to_tag.host_tags }}"
  loop: "{{ cloudstack_ops_host_tags_result.results | default([]) }}"
  loop_control:
    label: "{{ item.item.host_to_tag.hostname | default('N/A') }}"
  when:
    - cloudstack_ops_host_tags_result.results is defined
    - item.json is defined
    - not item.skipped | default(false)
