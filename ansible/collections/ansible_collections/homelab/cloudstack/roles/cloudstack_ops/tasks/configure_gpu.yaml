# Configure GPU devices on CloudStack hosts
---
# List hosts with GPU capabilities
- name: List hosts with GPU devices
  ansible.builtin.uri:
    url: "{{ cloudstack_api_url }}"
    method: POST
    body_format: form-urlencoded
    body:
      command: listHosts
      type: Routing
      zoneid: "{{ cloudstack_ops_zone_id }}"
      response: json
      sessionkey: "{{ cloudstack_session_key }}"
    headers:
      Cookie: "{{ cloudstack_cookies }}"
    return_content: true
    timeout: "{{ cloudstack_ops_async_timeout }}"
  register: cloudstack_ops_all_hosts

- name: Get zone ID for GPU configuration
  ansible.builtin.uri:
    url: "{{ cloudstack_api_url }}"
    method: POST
    body_format: form-urlencoded
    body:
      command: listZones
      name: "{{ cloudstack_ops_zone.name }}"
      response: json
      sessionkey: "{{ cloudstack_session_key }}"
    headers:
      Cookie: "{{ cloudstack_cookies }}"
    return_content: true
    timeout: "{{ cloudstack_ops_async_timeout }}"
  register: cloudstack_ops_zone_for_gpu

- name: Set zone ID
  ansible.builtin.set_fact:
    cloudstack_ops_gpu_zone_id: "{{ cloudstack_ops_zone_for_gpu.json.listzonesresponse.zone[0].id }}"
  when:
    - cloudstack_ops_zone_for_gpu.json.listzonesresponse.zone is defined
    - cloudstack_ops_zone_for_gpu.json.listzonesresponse.zone | length > 0

# Check for GPU groups on hosts
- name: List GPU groups in zone
  ansible.builtin.uri:
    url: "{{ cloudstack_api_url }}"
    method: POST
    body_format: form-urlencoded
    body:
      command: listGpuGroups
      zoneid: "{{ cloudstack_ops_gpu_zone_id }}"
      response: json
      sessionkey: "{{ cloudstack_session_key }}"
    headers:
      Cookie: "{{ cloudstack_cookies }}"
    return_content: true
    timeout: "{{ cloudstack_ops_async_timeout }}"
  register: cloudstack_ops_gpu_groups_list
  failed_when: false

- name: Display available GPU groups
  ansible.builtin.debug:
    msg: |
      GPU Groups in Zone {{ cloudstack_ops_zone.name }}:
      {{ cloudstack_ops_gpu_groups_list.json.listgpugroupsresponse.gpugroup | default([]) | to_nice_yaml }}
  when: cloudstack_ops_gpu_groups_list.json is defined

# List vGPU types if available
- name: List vGPU types
  ansible.builtin.uri:
    url: "{{ cloudstack_api_url }}"
    method: POST
    body_format: form-urlencoded
    body:
      command: listVGpuTypes
      zoneid: "{{ cloudstack_ops_gpu_zone_id }}"
      response: json
      sessionkey: "{{ cloudstack_session_key }}"
    headers:
      Cookie: "{{ cloudstack_cookies }}"
    return_content: true
    timeout: "{{ cloudstack_ops_async_timeout }}"
  register: cloudstack_ops_vgpu_types_list
  failed_when: false

- name: Display available vGPU types
  ansible.builtin.debug:
    msg: |
      vGPU Types available:
      {{ cloudstack_ops_vgpu_types_list.json.listvgputypesresponse.vgputype | default([]) | to_nice_yaml }}
  when: cloudstack_ops_vgpu_types_list.json is defined