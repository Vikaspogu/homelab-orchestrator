# CloudStack Ops Role - Main Tasks
---
- name: Validate required variables
  ansible.builtin.assert:
    that:
      - cloudstack_api_url is defined
      - cloudstack_ops_zone.name is defined
      - cloudstack_ops_zone.dns1 is defined
    fail_msg: "Required CloudStack configuration variables are not set"

- name: Get CloudStack API authentication
  ansible.builtin.include_role:
    name: homelab.cloudstack.api_auth
  when: cloudstack_session_key is not defined

- name: Create Zone
  ansible.builtin.include_tasks: create_zone.yaml
  tags:
    - zone

- name: Configure Physical Networks
  ansible.builtin.include_tasks: configure_physical_networks.yaml
  when: cloudstack_ops_physical_networks | length > 0
  tags:
    - network
    - physical_network

- name: Create Pods
  ansible.builtin.include_tasks: create_pods.yaml
  tags:
    - pod

- name: Configure Public IP Range (Advanced Zone)
  ansible.builtin.include_tasks: configure_public_ips.yaml
  when: cloudstack_ops_zone.network_type == "Advanced"
  tags:
    - network
    - public_ip

- name: Create Guest Networks
  ansible.builtin.include_tasks: create_networks.yaml
  when: cloudstack_ops_networks | length > 0
  tags:
    - network
    - guest_network

- name: Create Clusters
  ansible.builtin.include_tasks: create_clusters.yaml
  tags:
    - cluster

- name: Add Primary Storage
  ansible.builtin.include_tasks: add_primary_storage.yaml
  when: cloudstack_ops_primary_storages | length > 0
  tags:
    - storage
    - primary_storage

- name: Add Secondary Storage
  ansible.builtin.include_tasks: add_secondary_storage.yaml
  when: cloudstack_ops_secondary_storages | length > 0
  tags:
    - storage
    - secondary_storage

- name: Add Hosts
  ansible.builtin.include_tasks: add_hosts.yaml
  when: cloudstack_ops_hosts | length > 0
  tags:
    - hosts

- name: Configure GPU devices on hosts
  ansible.builtin.include_tasks: configure_gpu.yaml
  when: cloudstack_ops_gpu_groups | length > 0
  tags:
    - gpu
    - hosts

- name: Create SSH Key Pair
  ansible.builtin.include_tasks: create_ssh_key.yaml
  when: cloudstack_ops_ssh_key_name | length > 0
  tags:
    - ssh_key

- name: Enable Zone
  ansible.builtin.include_tasks: enable_zone.yaml
  when: cloudstack_ops_enable_zone
  tags:
    - zone
    - enable
