# Configure Proxmox Orchestrator Extension
---
- name: Check if Proxmox extension exists
  ansible.builtin.stat:
    path: /usr/share/cloudstack-management/extensions/Proxmox
  register: cloudstack_ops_proxmox_ext_path
  delegate_to: "{{ cloudstack_ops_management_host | default(inventory_hostname) }}"

- name: Fail if Proxmox extension not found
  ansible.builtin.fail:
    msg: "Proxmox extension not found at /usr/share/cloudstack-management/extensions/Proxmox. Ensure CloudStack 4.19+ is installed."
  when: not cloudstack_ops_proxmox_ext_path.stat.exists

- name: Check CloudStack extensions configuration
  ngine_io.cloudstack.configuration_info:
    api_url: "{{ cloudstack_api_url }}"
    api_key: "{{ cloudstack_api_key }}"
    api_secret: "{{ cloudstack_api_secret }}"
    name: "cloud.extensions.enabled"
  register: cloudstack_ops_extensions_config
  failed_when: false

- name: Enable extensions in CloudStack configuration
  ngine_io.cloudstack.configuration:
    api_url: "{{ cloudstack_api_url }}"
    api_key: "{{ cloudstack_api_key }}"
    api_secret: "{{ cloudstack_api_secret }}"
    name: "cloud.extensions.enabled"
    value: "true"
  when:
    - cloudstack_ops_extensions_config.configurations | default([]) | length > 0
    - (cloudstack_ops_extensions_config.configurations[0].value | default('false')) != 'true'

- name: List available extensions
  ansible.builtin.uri:
    url: "{{ cloudstack_api_url }}"
    method: POST
    body_format: form-urlencoded
    body:
      command: listExtensions
      response: json
      sessionkey: "{{ cloudstack_session_key }}"
    headers:
      Cookie: "{{ cloudstack_cookies }}"
    timeout: "{{ cloudstack_ops_async_timeout }}"
  register: cloudstack_ops_extensions_list

- name: Find Proxmox extension
  ansible.builtin.set_fact:
    cloudstack_ops_proxmox_ext: "{{ cloudstack_ops_extensions_list.json.listextensionsresponse.extension | default([]) | selectattr('name', 'search', 'Proxmox', 'ignorecase') | first | default({}) }}"

- name: Enable Proxmox extension
  ansible.builtin.uri:
    url: "{{ cloudstack_api_url }}"
    method: POST
    body_format: form-urlencoded
    body:
      command: updateExtension
      id: "{{ cloudstack_ops_proxmox_ext.id }}"
      state: "Enabled"
      response: json
      sessionkey: "{{ cloudstack_session_key }}"
    headers:
      Cookie: "{{ cloudstack_cookies }}"
    timeout: "{{ cloudstack_ops_async_timeout }}"
  when:
    - cloudstack_ops_proxmox_ext.id is defined
    - cloudstack_ops_proxmox_ext.state | default('') != 'Enabled'

- name: Register Proxmox hosts with extension
  ansible.builtin.uri:
    url: "{{ cloudstack_api_url }}"
    method: POST
    body_format: form-urlencoded
    body:
      command: runExtensionCustomAction
      extensionid: "{{ cloudstack_ops_proxmox_ext.id }}"
      customaction: "registerHost"
      parameters: "{{ {'name': proxmox_host.name, 'url': proxmox_host.url, 'username': proxmox_host.username, 'tokenid': proxmox_host.token_id, 'tokensecret': proxmox_host.token_secret, 'node': proxmox_host.node | default(proxmox_host.name), 'verifyssl': proxmox_host.verify_ssl | default(false) | string | lower} | to_json }}"
      response: json
      sessionkey: "{{ cloudstack_session_key }}"
    headers:
      Cookie: "{{ cloudstack_cookies }}"
    timeout: "{{ cloudstack_ops_async_timeout }}"
  loop: "{{ cloudstack_ops_proxmox_extension.hosts }}"
  loop_control:
    loop_var: proxmox_host
    label: "{{ proxmox_host.name }}"
  when:
    - cloudstack_ops_proxmox_ext.id is defined
    - cloudstack_ops_proxmox_extension.hosts | length > 0
  register: cloudstack_ops_proxmox_register_result
  failed_when: false
  no_log: true

- name: List registered Proxmox resources
  ansible.builtin.uri:
    url: "{{ cloudstack_api_url }}"
    method: POST
    body_format: form-urlencoded
    body:
      command: listExternalResources
      extensionid: "{{ cloudstack_ops_proxmox_ext.id }}"
      response: json
      sessionkey: "{{ cloudstack_session_key }}"
    headers:
      Cookie: "{{ cloudstack_cookies }}"
    timeout: "{{ cloudstack_ops_async_timeout }}"
  register: cloudstack_ops_proxmox_resources
  when: cloudstack_ops_proxmox_ext.id is defined
