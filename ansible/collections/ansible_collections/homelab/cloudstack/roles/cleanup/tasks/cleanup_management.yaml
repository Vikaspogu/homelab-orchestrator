# Cleanup CloudStack Management Server
---
- name: Stop CloudStack management
  ansible.builtin.systemd:
    name: cloudstack-management
    state: stopped
  failed_when: false

- name: Stop MySQL
  ansible.builtin.systemd:
    name: mysql
    state: stopped
  failed_when: false
  when: cleanup_database

- name: Remove CloudStack packages
  ansible.builtin.apt:
    name: [cloudstack-management, cloudstack-common, cloudstack-ui]
    state: absent
    purge: true
  when: cleanup_packages

- name: Remove MySQL packages
  ansible.builtin.apt:
    name: [mysql-server, mysql-client, mysql-common]
    state: absent
    purge: true
  when: cleanup_packages and cleanup_database

- name: Remove CloudStack directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/cloudstack
    - /var/cloudstack
    - /usr/share/cloudstack-management
    - /usr/share/cloudstack-common
  when: cleanup_config

- name: Remove MySQL directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop: [/var/lib/mysql, /etc/mysql, /var/log/mysql]
  when: cleanup_database

- name: Remove logs
  ansible.builtin.file:
    path: /var/log/cloudstack
    state: absent
  when: cleanup_logs

- name: Remove APT repository
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/apt/sources.list.d/cloudstack.list
    - /etc/apt/keyrings/cloudstack.gpg
  when: cleanup_repo

- name: Update APT and autoremove
  ansible.builtin.apt:
    update_cache: true
    autoremove: true
    purge: true
