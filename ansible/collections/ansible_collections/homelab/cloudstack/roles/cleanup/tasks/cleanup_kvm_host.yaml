# Cleanup CloudStack KVM Host
---
- name: Stop CloudStack agent
  ansible.builtin.systemd:
    name: cloudstack-agent
    state: stopped
  failed_when: false

- name: Stop libvirtd
  ansible.builtin.systemd:
    name: libvirtd
    state: stopped
  failed_when: false
  when: cleanup_libvirt

- name: Remove CloudStack agent packages
  ansible.builtin.apt:
    name: [cloudstack-agent, cloudstack-common]
    state: absent
    purge: true
  when: cleanup_packages

- name: Remove libvirt packages
  ansible.builtin.apt:
    name: [qemu-kvm, libvirt-daemon-system, libvirt-clients, bridge-utils]
    state: absent
    purge: true
  when: cleanup_packages and cleanup_libvirt

- name: Remove CloudStack directories
  ansible.builtin.file:
    path: '{{ item }}'
    state: absent
  loop: [/etc/cloudstack, /var/log/cloudstack]
  when: cleanup_config

- name: Remove libvirt directories
  ansible.builtin.file:
    path: '{{ item }}'
    state: absent
  loop: [/etc/libvirt, /var/lib/libvirt, /var/log/libvirt]
  when: cleanup_libvirt

- name: Remove local storage
  ansible.builtin.file:
    path: '{{ cleanup_local_storage_path }}'
    state: absent
  when: cleanup_storage

- name: Remove network bridges
  when: cleanup_network
  block:
    - name: Get bridges
      ansible.builtin.command: brctl show
      register: cleanup_bridge_list
      changed_when: false
      failed_when: false

    - name: Remove bridges
      ansible.builtin.shell: |
        ip link set {{ item }} down
        brctl delbr {{ item }}
      loop: '{{ cleanup_bridges_to_remove }}'
      when: item in cleanup_bridge_list.stdout
      changed_when: true
      failed_when: false

- name: Remove netplan config
  ansible.builtin.file:
    path: /etc/netplan/60-cloudstack-bridges.yaml
    state: absent
  when: cleanup_network

- name: Remove APT repository
  ansible.builtin.file:
    path: '{{ item }}'
    state: absent
  loop:
    - /etc/apt/sources.list.d/cloudstack.list
    - /etc/apt/keyrings/cloudstack.gpg
  when: cleanup_repo

- name: Update APT and autoremove
  ansible.builtin.apt:
    update_cache: true
    autoremove: true
    purge: true
