# Create Compute Offering for CloudStack Kubernetes Service
---
- name: List existing compute offerings
  ansible.builtin.uri:
    url: "{{ cloudstack_api_url }}"
    method: POST
    body_format: form-urlencoded
    body:
      command: listServiceOfferings
      name: "{{ cloudstack_kubernetes_compute_offering.name }}"
      response: json
      sessionkey: "{{ cloudstack_session_key }}"
    headers:
      Cookie: "{{ cloudstack_cookies }}"
    return_content: true
  register: existing_offerings

- name: Check if offering already exists
  ansible.builtin.set_fact:
    offering_exists: "{{ (existing_offerings.json.listserviceofferingsresponse.serviceoffering | default([]) | length) > 0 }}"

- name: Create Kubernetes compute offering
  ansible.builtin.uri:
    url: "{{ cloudstack_api_url }}"
    method: POST
    body_format: form-urlencoded
    body:
      command: createServiceOffering
      name: "{{ cloudstack_kubernetes_compute_offering.name }}"
      displaytext: "{{ cloudstack_kubernetes_compute_offering.display_text | default(cloudstack_kubernetes_compute_offering.name) }}"
      cpunumber: "{{ cloudstack_kubernetes_compute_offering.cpu }}"
      cpuspeed: "{{ cloudstack_kubernetes_compute_offering.cpu_speed }}"
      memory: "{{ cloudstack_kubernetes_compute_offering.memory }}"
      storagetype: "{{ cloudstack_kubernetes_compute_offering.storage_type | default('shared') }}"
      offerha: "{{ cloudstack_kubernetes_compute_offering.offer_ha | default(false) | lower }}"
      response: json
      sessionkey: "{{ cloudstack_session_key }}"
    headers:
      Cookie: "{{ cloudstack_cookies }}"
    return_content: true
  register: create_offering_result
  when: not offering_exists
  failed_when: >
    create_offering_result is failed and
    'already exists' not in (create_offering_result.json.createserviceofferingresponse.errortext | default(''))

- name: Display compute offering status
  ansible.builtin.debug:
    msg: |
      Kubernetes Compute Offering:
        Name: {{ cloudstack_kubernetes_compute_offering.name }}
        CPU: {{ cloudstack_kubernetes_compute_offering.cpu }} cores @ {{ cloudstack_kubernetes_compute_offering.cpu_speed }} MHz
        Memory: {{ cloudstack_kubernetes_compute_offering.memory }} MB
        Status: {{ 'Created' if not offering_exists else 'Already exists' }}

