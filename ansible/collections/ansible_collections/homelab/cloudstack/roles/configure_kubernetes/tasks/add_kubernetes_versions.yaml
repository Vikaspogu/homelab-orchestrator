# Add Kubernetes Supported Versions
---
- name: List all zones
  ansible.builtin.uri:
    url: "{{ cloudstack_api_url }}"
    method: POST
    body_format: form-urlencoded
    body:
      command: listZones
      response: json
      sessionkey: "{{ cloudstack_session_key }}"
    headers:
      Cookie: "{{ cloudstack_cookies }}"
    return_content: true
  register: configure_kubernetes_zones_info_response

- name: Set zones info
  ansible.builtin.set_fact:
    configure_kubernetes_zones_info:
      zones: "{{ configure_kubernetes_zones_info_response.json.listzonesresponse.zone | default([]) }}"

- name: Build zone name to ID mapping
  ansible.builtin.set_fact:
    configure_kubernetes_zone_id_map: "{{ configure_kubernetes_zone_id_map | default({}) | combine({item.name: item.id}) }}"
  loop: "{{ configure_kubernetes_zones_info.zones | default([]) }}"

- name: List existing Kubernetes supported versions
  ansible.builtin.uri:
    url: "{{ cloudstack_api_url }}"
    method: POST
    body_format: form-urlencoded
    body:
      command: listKubernetesSupportedVersions
      response: json
      sessionkey: "{{ cloudstack_session_key }}"
    headers:
      Cookie: "{{ cloudstack_cookies }}"
    return_content: true
  register: configure_kubernetes_existing_versions

- name: Build list of existing semantic versions
  ansible.builtin.set_fact:
    configure_kubernetes_existing_semantic_versions: >-
      {{ configure_kubernetes_existing_versions.json.listkubernetessupportedversionsresponse.kubernetessupportedversion |
         default([]) | map(attribute='semanticversion') | list }}

- name: Add Kubernetes supported versions
  ansible.builtin.uri:
    url: "{{ cloudstack_api_url }}"
    method: POST
    body_format: form-urlencoded
    body:
      command: addKubernetesSupportedVersion
      name: "{{ item.name }}"
      semanticversion: "{{ item.semantic_version }}"
      url: "{{ item.url }}"
      zoneid: "{{ item.zone_id | default(configure_kubernetes_zone_id_map[item.zone_name]) }}"
      mincpunumber: "{{ item.min_cpu | default(2) }}"
      minmemory: "{{ item.min_memory | default(2048) }}"
      directdownload: true
      response: json
      sessionkey: "{{ cloudstack_session_key }}"
    headers:
      Cookie: "{{ cloudstack_cookies }}"
    return_content: true
  loop: "{{ configure_kubernetes_versions }}"
  register: configure_kubernetes_add_version_results
  when: item.semantic_version not in configure_kubernetes_existing_semantic_versions
  failed_when: >
    configure_kubernetes_add_version_results is failed and
    'already exists' not in (configure_kubernetes_add_version_results.json.addkubernetessupportedversionresponse.errortext | default(''))

- name: Display added Kubernetes versions
  ansible.builtin.debug:
    msg: |
      Kubernetes versions processed:
      {% for version in configure_kubernetes_versions %}
      - {{ version.name }} ({{ version.semantic_version }}): {{ 'Added' if version.semantic_version not in configure_kubernetes_existing_semantic_versions else 'Already exists' }}
      {% endfor %}
