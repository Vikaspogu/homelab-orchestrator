# Configure additional storage devices with MergeFS for CloudStack local storage
---
- name: Install filesystem and MergeFS utilities
  ansible.builtin.apt:
    name: [xfsprogs, nvme-cli, mergerfs]
    state: present
    update_cache: true

- name: Check if devices exist
  ansible.builtin.stat:
    path: "{{ storage.device }}"
  loop: "{{ prepare_kvm_additional_storage }}"
  loop_control:
    loop_var: storage
    label: "{{ storage.device }}"
  register: prepare_kvm_storage_devices

- name: Fail if any device does not exist
  ansible.builtin.fail:
    msg: "Device {{ item.storage.device }} does not exist!"
  loop: "{{ prepare_kvm_storage_devices.results }}"
  loop_control:
    label: "{{ item.storage.device }}"
  when: not item.stat.exists

- name: Gather mount facts
  ansible.builtin.setup:
    gather_subset: [mounts]

- name: Build mounted devices list
  ansible.builtin.set_fact:
    prepare_kvm_mounted_devices: "{{ ansible_mounts | map(attribute='device') | list }}"

- name: Check if devices have filesystem
  ansible.builtin.command:
    cmd: "blkid -s TYPE -o value {{ storage.device }}"
  loop: "{{ prepare_kvm_additional_storage }}"
  loop_control:
    loop_var: storage
    label: "{{ storage.device }}"
  register: prepare_kvm_blkid_check
  changed_when: false
  failed_when: false

- name: Create filesystem on devices
  community.general.filesystem:
    fstype: "{{ item.storage.filesystem | default('xfs') }}"
    dev: "{{ item.storage.device }}"
    opts: "{{ '-L ' + item.storage.label if item.storage.label is defined else omit }}"
  loop: "{{ prepare_kvm_blkid_check.results }}"
  loop_control:
    label: "{{ item.storage.device }}"
  when:
    - item.stdout | trim == ''
    - item.storage.device not in prepare_kvm_mounted_devices

- name: Create disk mount directories
  ansible.builtin.file:
    path: "{{ prepare_kvm_mergefs_branch_path }}/disk{{ idx }}"
    state: directory
    mode: "0755"
  loop: "{{ prepare_kvm_additional_storage }}"
  loop_control:
    index_var: idx
    loop_var: storage
    label: "{{ storage.device }}"

- name: Get device UUIDs
  ansible.builtin.command: "blkid -s UUID -o value {{ storage.device }}"
  loop: "{{ prepare_kvm_additional_storage }}"
  loop_control:
    loop_var: storage
    label: "{{ storage.device }}"
  register: prepare_kvm_device_uuids
  changed_when: false
  failed_when: item.rc != 0 or item.stdout | trim == ''

- name: Mount individual storage devices
  ansible.posix.mount:
    path: "{{ prepare_kvm_mergefs_branch_path }}/disk{{ idx }}"
    src: "UUID={{ item.stdout }}"
    fstype: "{{ item.storage.filesystem | default('xfs') }}"
    opts: "{{ item.storage.mount_options | default('noatime,nodiratime') }}"
    state: mounted
  loop: "{{ prepare_kvm_device_uuids.results }}"
  loop_control:
    index_var: idx
    label: "{{ item.storage.device }}"
  when: item.storage.device not in prepare_kvm_mounted_devices

- name: Create MergeFS mount point
  ansible.builtin.file:
    path: "{{ prepare_kvm_mergefs_mount_point }}"
    state: directory
    mode: "0755"

- name: Build MergeFS branch paths
  ansible.builtin.set_fact:
    prepare_kvm_mergefs_branches: "{{ range(prepare_kvm_additional_storage | length) | map('regex_replace', '^(.*)$', prepare_kvm_mergefs_branch_path + '/disk\\1') | join(':') }}"

- name: Mount MergeFS pool
  ansible.posix.mount:
    path: "{{ prepare_kvm_mergefs_mount_point }}"
    src: "{{ prepare_kvm_mergefs_branches }}"
    fstype: fuse.mergerfs
    opts: "{{ prepare_kvm_mergefs_options }}"
    state: mounted
