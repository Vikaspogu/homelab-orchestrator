# Install and Configure libvirt for CloudStack KVM Host
---
- name: Install libvirt and KVM packages
  ansible.builtin.apt:
    name: "{{ prepare_kvm_libvirt_packages }}"
    state: present
    update_cache: true

# Configure libvirtd.conf
- name: Configure libvirtd - listen_tls
  ansible.builtin.lineinfile:
    path: "{{ prepare_kvm_libvirtd_config_file }}"
    regexp: "^#?listen_tls\\s*="
    line: "listen_tls = {{ prepare_kvm_libvirt_listen_tls }}"
    backup: true
  notify: Restart libvirt

- name: Configure libvirtd - listen_tcp
  ansible.builtin.lineinfile:
    path: "{{ prepare_kvm_libvirtd_config_file }}"
    regexp: "^#?listen_tcp\\s*="
    line: "listen_tcp = {{ prepare_kvm_libvirt_listen_tcp }}"
  notify: Restart libvirt

- name: Configure libvirtd - tls_port
  ansible.builtin.lineinfile:
    path: "{{ prepare_kvm_libvirtd_config_file }}"
    regexp: "^#?tls_port\\s*="
    line: 'tls_port = "{{ prepare_kvm_libvirt_tls_port }}"'
  notify: Restart libvirt

- name: Configure libvirtd - tcp_port
  ansible.builtin.lineinfile:
    path: "{{ prepare_kvm_libvirtd_config_file }}"
    regexp: "^#?tcp_port\\s*="
    line: 'tcp_port = "{{ prepare_kvm_libvirt_tcp_port }}"'
  notify: Restart libvirt

- name: Configure libvirtd - auth_tcp
  ansible.builtin.lineinfile:
    path: "{{ prepare_kvm_libvirtd_config_file }}"
    regexp: "^#?auth_tcp\\s*="
    line: 'auth_tcp = "{{ prepare_kvm_libvirt_auth_tcp }}"'
  notify: Restart libvirt

- name: Configure libvirtd - mdns_adv
  ansible.builtin.lineinfile:
    path: "{{ prepare_kvm_libvirtd_config_file }}"
    regexp: "^#?mdns_adv\\s*="
    line: "mdns_adv = {{ prepare_kvm_libvirt_mdns_adv }}"
  notify: Restart libvirt

# Configure libvirt.conf for legacy mode
- name: Ensure libvirt.conf exists
  ansible.builtin.file:
    path: "{{ prepare_kvm_libvirt_config_file }}"
    state: touch
    mode: "0644"
  changed_when: false

- name: Configure libvirt to use legacy remote mode
  ansible.builtin.lineinfile:
    path: "{{ prepare_kvm_libvirt_config_file }}"
    regexp: "^#?remote_mode\\s*="
    line: 'remote_mode="legacy"'
    create: true
    mode: "0644"
  notify: Restart libvirt

# Configure libvirtd default for listening (Ubuntu specific)
- name: Check Ubuntu version
  ansible.builtin.set_fact:
    prepare_kvm_ubuntu_version: "{{ ansible_distribution_version | float }}"
  when: ansible_distribution == "Ubuntu"

- name: Configure libvirtd to listen (Ubuntu 22.04+)
  ansible.builtin.lineinfile:
    path: "{{ prepare_kvm_libvirtd_default_file }}"
    regexp: "^#?LIBVIRTD_ARGS="
    line: 'LIBVIRTD_ARGS="--listen"'
    create: true
    mode: "0644"
  when:
    - ansible_distribution == "Ubuntu"
    - prepare_kvm_ubuntu_version | default(0) | float >= 22.04
  notify: Restart libvirt

- name: Configure libvirtd to listen (Ubuntu < 22.04)
  ansible.builtin.lineinfile:
    path: "{{ prepare_kvm_libvirtd_default_file }}"
    regexp: "^#?libvirtd_opts="
    line: 'libvirtd_opts="-l"'
    create: true
    mode: "0644"
  when:
    - ansible_distribution == "Ubuntu"
    - prepare_kvm_ubuntu_version | default(0) | float < 22.04
  notify: Restart libvirt

# Mask libvirt sockets for traditional mode (Ubuntu 24.04+)
- name: Mask libvirt sockets for traditional mode (Ubuntu 24.04+)
  ansible.builtin.systemd:
    name: "{{ item }}"
    masked: true
  loop:
    - libvirtd.socket
    - libvirtd-ro.socket
    - libvirtd-admin.socket
    - libvirtd-tls.socket
    - libvirtd-tcp.socket
  when:
    - ansible_distribution == "Ubuntu"
    - prepare_kvm_ubuntu_version | default(0) | float >= 24.04
  notify: Restart libvirt

# Start and enable libvirt service
- name: Enable and start libvirt service
  ansible.builtin.systemd:
    name: "{{ prepare_kvm_libvirt_service }}"
    enabled: "{{ prepare_kvm_enable_services }}"
    state: started
    daemon_reload: true

# Flush handlers to ensure libvirt is restarted before continuing
- name: Flush handlers
  ansible.builtin.meta: flush_handlers
