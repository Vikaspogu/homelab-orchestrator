# Configure UFW Firewall for CloudStack KVM Host
---
- name: Check if UFW is installed
  ansible.builtin.command: which ufw
  register: ufw_installed
  changed_when: false
  failed_when: false

- name: Configure UFW firewall
  when: ufw_installed.rc == 0
  block:
    - name: Allow CloudStack required ports through UFW
      community.general.ufw:
        rule: allow
        port: "{{ item.port | string }}"
        proto: "{{ item.proto }}"
      loop: "{{ cloudstack_firewall_ports }}"

    - name: Check UFW default forward policy
      ansible.builtin.command: grep DEFAULT_FORWARD_POLICY /etc/default/ufw
      register: ufw_forward_policy
      changed_when: false
      failed_when: false

    - name: Set UFW default forward policy to ACCEPT (Ubuntu 22.04+)
      ansible.builtin.lineinfile:
        path: /etc/default/ufw
        regexp: "^DEFAULT_FORWARD_POLICY="
        line: 'DEFAULT_FORWARD_POLICY="ACCEPT"'
        backup: true
      when: "'DROP' in ufw_forward_policy.stdout"
      notify: Reload UFW

    - name: Enable UFW
      community.general.ufw:
        state: enabled

- name: Display firewall configuration
  ansible.builtin.debug:
    msg: |
      Firewall ports configured:
      {% for port in cloudstack_firewall_ports %}
        - {{ port.port }}/{{ port.proto }}
      {% endfor %}
  when: ufw_installed.rc == 0

