# Setup VFIO for NVIDIA GPU Passthrough
---
- name: Update PCI IDs database
  ansible.builtin.command:
    cmd: update-pciids
  changed_when: true

- name: Copy the GPU configuration script to the target machine
  ansible.builtin.copy:
    src: list_and_configure_gpus.py
    dest: /tmp/list_and_configure_gpus.py
    mode: '0755'

- name: Run the GPU configuration script
  ansible.builtin.command:
    cmd: python3 /tmp/list_and_configure_gpus.py
  register: prepare_kvm_script_result
  changed_when: true

- name: Display the result of the GPU configuration script
  ansible.builtin.debug:
    msg: "{{ prepare_kvm_script_result.stdout }}"

- name: Blacklist NVIDIA and nouveau drivers
  ansible.builtin.copy:
    dest: /etc/modprobe.d/blacklist-nvidia.conf
    content: |
      blacklist nouveau
      blacklist nvidia
      blacklist nvidiafb
      blacklist nvidia_drm
      blacklist snd_hda_intel
    mode: '0644'

- name: Configure VFIO modules to load at boot
  ansible.builtin.copy:
    dest: /etc/modules-load.d/vfio.conf
    content: |
      vfio
      vfio_iommu_type1
      vfio_pci
    mode: '0644'

- name: Load VFIO modules now
  community.general.modprobe:
    name: "{{ item }}"
    state: present
  loop:
    - vfio
    - vfio_iommu_type1
    - vfio_pci
  failed_when: false

- name: Install HWE kernel for Ubuntu 22.04
  ansible.builtin.apt:
    name: linux-generic-hwe-22.04
    state: present
    install_recommends: true
  when: ansible_facts['distribution'] == 'Ubuntu' and ansible_facts['distribution_version'] is version('22.04', '==')
  register: prepare_kvm_hwe_kernel_22

- name: Install HWE kernel for Ubuntu 24.04
  ansible.builtin.apt:
    name: linux-generic-hwe-24.04
    state: present
    install_recommends: true
  when: ansible_facts['distribution'] == 'Ubuntu' and ansible_facts['distribution_version'] is version('24.04', '==')
  register: prepare_kvm_hwe_kernel_24

- name: Update initramfs
  ansible.builtin.command:
    cmd: update-initramfs -u
  changed_when: true

- name: Set root password for CloudStack agent
  ansible.builtin.user:
    name: root
    password: "{{ prepare_kvm_root_password | password_hash('sha512') }}"
  when: prepare_kvm_root_password is defined and prepare_kvm_root_password | length > 0
  no_log: true

- name: Reboot system to apply VFIO and kernel updates
  ansible.builtin.reboot:
    reboot_timeout: 1800
    msg: "Rebooting to apply VFIO GPU passthrough and kernel updates"
  when: prepare_kvm_vfio_reboot | default(true) and (prepare_kvm_hwe_kernel_22.changed | default(false) or prepare_kvm_hwe_kernel_24.changed | default(false))

- name: Wait for system to come back online
  ansible.builtin.wait_for_connection:
    delay: 30
    timeout: 600
  when: prepare_kvm_vfio_reboot | default(true) and (prepare_kvm_hwe_kernel_22.changed | default(false) or prepare_kvm_hwe_kernel_24.changed | default(false))

- name: Verify VFIO modules are loaded
  ansible.builtin.shell: set -o pipefail && lsmod | grep vfio
  register: prepare_kvm_vfio_loaded
  changed_when: false
  failed_when: false

- name: Display VFIO status
  ansible.builtin.debug:
    msg: |
      VFIO GPU Passthrough Configuration Complete!

      VFIO modules loaded:
      {{ prepare_kvm_vfio_loaded.stdout | default('No VFIO modules loaded - reboot may be required') }}

      To verify GPU is bound to vfio-pci:
        lspci -nnk | grep -A3 NVIDIA
