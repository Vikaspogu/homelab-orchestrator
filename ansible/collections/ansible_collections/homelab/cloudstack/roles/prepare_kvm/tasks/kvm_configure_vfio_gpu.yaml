# Setup VFIO for GPU Passthrough
---
- name: Install GPU discovery prerequisites
  ansible.builtin.apt:
    name:
      - pciutils
      - xmlstarlet
    state: present

- name: Install NVIDIA driver build dependencies
  ansible.builtin.apt:
    name:
      - gcc
      - make
      - "linux-headers-{{ ansible_kernel }}"
    state: present
    update_cache: true

- name: Download NVIDIA driver
  ansible.builtin.get_url:
    url: "{{ prepare_kvm_nvidia_driver_url }}"
    dest: "/tmp/{{ prepare_kvm_nvidia_driver_url | basename }}"
    mode: '0755'
  when: prepare_kvm_nvidia_driver_url | default('') | length > 0

- name: Install NVIDIA driver
  ansible.builtin.command:
    cmd: "/tmp/{{ prepare_kvm_nvidia_driver_url | basename }} --silent --no-questions --ui=none"
    creates: /usr/bin/nvidia-smi
  when: prepare_kvm_nvidia_driver_url | default('') | length > 0
  register: prepare_kvm_nvidia_driver_installed

- name: Detect CPU vendor
  ansible.builtin.slurp:
    src: /proc/cpuinfo
  register: prepare_kvm_cpuinfo

- name: Set IOMMU kernel parameter
  ansible.builtin.set_fact:
    prepare_kvm_iommu_param: "{{ 'intel_iommu=on' if 'GenuineIntel' in (prepare_kvm_cpuinfo.content | b64decode) else 'amd_iommu=on' }}"

- name: Check current GRUB configuration
  ansible.builtin.slurp:
    src: /etc/default/grub
  register: prepare_kvm_grub_config

- name: Enable IOMMU in GRUB
  ansible.builtin.lineinfile:
    path: /etc/default/grub
    regexp: '^GRUB_CMDLINE_LINUX_DEFAULT='
    line: 'GRUB_CMDLINE_LINUX_DEFAULT="quiet splash {{ prepare_kvm_iommu_param }} iommu=pt"'
    backup: true
  register: prepare_kvm_grub_updated
  when: prepare_kvm_iommu_param not in (prepare_kvm_grub_config.content | b64decode)
  notify: Update GRUB

- name: Update PCI IDs database
  ansible.builtin.command: update-pciids
  changed_when: true

- name: Copy GPU configuration script
  ansible.builtin.copy:
    src: list_and_configure_gpus.py
    dest: /tmp/list_and_configure_gpus.py
    mode: '0755'

- name: Run GPU configuration script
  ansible.builtin.command: python3 /tmp/list_and_configure_gpus.py
  changed_when: true

- name: Blacklist NVIDIA and nouveau drivers
  ansible.builtin.copy:
    dest: /etc/modprobe.d/blacklist-nvidia.conf
    content: |
      blacklist nouveau
      blacklist nvidia
      blacklist nvidiafb
      blacklist nvidia_drm
      blacklist snd_hda_intel
    mode: '0644'

- name: Configure VFIO modules to load at boot
  ansible.builtin.copy:
    dest: /etc/modules-load.d/vfio.conf
    content: |
      vfio
      vfio_iommu_type1
      vfio_pci
    mode: '0644'

- name: Load VFIO modules
  community.general.modprobe:
    name: '{{ item }}'
    state: present
  loop: [vfio, vfio_iommu_type1, vfio_pci]
  failed_when: false

- name: Install HWE kernel for Ubuntu
  ansible.builtin.apt:
    name: "linux-generic-hwe-{{ ansible_facts['distribution_version'] }}"
    state: present
  when: ansible_distribution == 'Ubuntu'
  register: prepare_kvm_hwe_kernel
  failed_when: false

- name: Update initramfs
  ansible.builtin.command: update-initramfs -u
  changed_when: true

- name: Set root password for CloudStack agent
  ansible.builtin.user:
    name: root
    password: "{{ prepare_kvm_root_password | password_hash('sha512') }}"
  when: prepare_kvm_root_password | default('') | length > 0
  no_log: true

- name: Reboot if required
  ansible.builtin.reboot:
    reboot_timeout: 1800
    msg: 'Rebooting to apply VFIO GPU passthrough'
  when:
    - prepare_kvm_vfio_reboot | default(true)
    - prepare_kvm_grub_updated.changed | default(false) or prepare_kvm_hwe_kernel.changed | default(false)

- name: Wait for system to come back online
  ansible.builtin.wait_for_connection:
    delay: 30
    timeout: 600
  when:
    - prepare_kvm_vfio_reboot | default(true)
    - prepare_kvm_grub_updated.changed | default(false) or prepare_kvm_hwe_kernel.changed | default(false)

- name: Verify VFIO modules are loaded
  ansible.builtin.command: lsmod
  register: prepare_kvm_lsmod
  changed_when: false
  failed_when: "'vfio' not in prepare_kvm_lsmod.stdout"
