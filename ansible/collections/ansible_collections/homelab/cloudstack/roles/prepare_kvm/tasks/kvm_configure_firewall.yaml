# Configure UFW Firewall for CloudStack KVM Host
---
- name: Check if UFW is installed
  ansible.builtin.command: which ufw
  register: prepare_kvm_ufw_installed
  changed_when: false
  failed_when: false

- name: Configure UFW firewall
  when: prepare_kvm_ufw_installed.rc == 0
  block:
    - name: Allow CloudStack required ports
      community.general.ufw:
        rule: allow
        port: "{{ item.port | string }}"
        proto: "{{ item.proto }}"
      loop: "{{ prepare_kvm_firewall_ports }}"
      loop_control:
        label: "{{ item.port }}/{{ item.proto }}"

    - name: Check UFW default forward policy
      ansible.builtin.command: grep DEFAULT_FORWARD_POLICY /etc/default/ufw
      register: prepare_kvm_ufw_forward_policy
      changed_when: false
      failed_when: false

    - name: Set UFW forward policy to ACCEPT
      ansible.builtin.lineinfile:
        path: /etc/default/ufw
        regexp: "^DEFAULT_FORWARD_POLICY="
        line: 'DEFAULT_FORWARD_POLICY="ACCEPT"'
        backup: true
      when: "'DROP' in prepare_kvm_ufw_forward_policy.stdout"
      notify: Reload UFW

    - name: Enable UFW
      community.general.ufw:
        state: enabled
