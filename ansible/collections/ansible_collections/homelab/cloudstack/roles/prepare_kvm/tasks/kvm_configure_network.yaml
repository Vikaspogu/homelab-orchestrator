# Configure Network Bridges for CloudStack KVM Host
---
- name: Disable bridge netfilter for CloudStack networking
  ansible.posix.sysctl:
    name: "{{ item }}"
    value: "0"
    sysctl_set: true
    state: present
    reload: true
  loop:
    - net.bridge.bridge-nf-call-iptables
    - net.bridge.bridge-nf-call-ip6tables
    - net.bridge.bridge-nf-call-arptables
  failed_when: false

- name: Check if netplan is available
  ansible.builtin.stat:
    path: /usr/sbin/netplan
  register: prepare_kvm_netplan_check

- name: Set netplan usage fact
  ansible.builtin.set_fact:
    prepare_kvm_use_netplan: "{{ prepare_kvm_netplan_check.stat.exists and prepare_kvm_use_netplan }}"

# Configure using Netplan (Ubuntu 20.04+)
- name: Configure network bridges using Netplan
  when: prepare_kvm_use_netplan
  block:
    - name: Create Netplan configuration
      ansible.builtin.template:
        src: netplan-bridges.yaml.j2
        dest: "{{ prepare_kvm_netplan_config_file }}"
        mode: "0600"
        backup: true
      register: prepare_kvm_netplan_config

    - name: Apply Netplan configuration  # noqa: no-handler
      ansible.builtin.command: netplan apply
      when: prepare_kvm_netplan_config.changed
      changed_when: true

# Configure using /etc/network/interfaces (older systems)
- name: Configure network bridges using interfaces file
  when: not prepare_kvm_use_netplan
  block:
    - name: Configure network interfaces
      ansible.builtin.template:
        src: interfaces.j2
        dest: "{{ prepare_kvm_interfaces_config_file }}"
        mode: "0644"
        backup: true
