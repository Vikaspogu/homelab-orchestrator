# Configure Network Bridges for CloudStack KVM Host (Native Linux Bridges)
---
- name: Disable bridge netfilter for CloudStack networking
  ansible.posix.sysctl:
    name: "{{ item }}"
    value: "0"
    sysctl_set: true
    state: present
    reload: true
  loop:
    - net.bridge.bridge-nf-call-iptables
    - net.bridge.bridge-nf-call-ip6tables
    - net.bridge.bridge-nf-call-arptables
  failed_when: false

- name: Check if netplan is available
  ansible.builtin.stat:
    path: /usr/sbin/netplan
  register: prepare_kvm_netplan_check

- name: Set netplan usage fact
  ansible.builtin.set_fact:
    prepare_kvm_use_netplan: "{{ prepare_kvm_netplan_check.stat.exists and prepare_kvm_use_netplan }}"

# Configure using Netplan (Ubuntu 20.04+)
- name: Configure network bridges using Netplan
  when: prepare_kvm_use_netplan
  block:
    - name: Create Netplan configuration for CloudStack bridges
      ansible.builtin.template:
        src: netplan-bridges.yaml.j2
        dest: "{{ prepare_kvm_netplan_config_file }}"
        owner: root
        group: root
        mode: "0600"
        backup: true
      register: prepare_kvm_netplan_config

    - name: Apply Netplan configuration  # noqa: no-handler
      ansible.builtin.command: netplan apply
      when: prepare_kvm_netplan_config.changed
      changed_when: true

# Configure using /etc/network/interfaces (older Ubuntu/Debian)
- name: Configure network bridges using interfaces file
  when: not prepare_kvm_use_netplan
  block:
    - name: Backup existing interfaces file
      ansible.builtin.copy:
        src: "{{ prepare_kvm_interfaces_config_file }}"
        dest: "{{ prepare_kvm_interfaces_config_file }}.backup.{{ ansible_date_time.epoch }}"
        remote_src: true
        mode: "0644"
      failed_when: false

    - name: Configure network interfaces for CloudStack bridges
      ansible.builtin.template:
        src: interfaces.j2
        dest: "{{ prepare_kvm_interfaces_config_file }}"
        owner: root
        group: root
        mode: "0644"
        backup: true
      register: prepare_kvm_interfaces_config

    - name: Display network restart warning  # noqa: no-handler
      ansible.builtin.debug:
        msg: >
          Network configuration has been updated. A network restart or reboot
          is required to apply the changes. Run 'systemctl restart networking'
          or reboot the system.
      when: prepare_kvm_interfaces_config.changed

- name: Display network configuration info
  ansible.builtin.debug:
    msg: |
      Network bridges configured:
        Management bridge: {{ prepare_kvm_mgmt_bridge }} ({{ prepare_kvm_mgmt_interface }})
        Guest bridge: {{ prepare_kvm_guest_bridge }} ({{ prepare_kvm_guest_interface }})
        Single NIC mode: {{ prepare_kvm_mgmt_bridge == prepare_kvm_guest_bridge }}
        Network mode: {{ prepare_kvm_network_mode }}
        Using Netplan: {{ prepare_kvm_use_netplan }}
