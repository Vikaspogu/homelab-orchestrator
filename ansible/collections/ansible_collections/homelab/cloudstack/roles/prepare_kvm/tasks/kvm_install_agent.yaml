# Install and Configure CloudStack Agent
---
- name: Install CloudStack Agent
  ansible.builtin.apt:
    name: "{{ prepare_kvm_agent_packages }}"
    state: present
    update_cache: true

- name: Check Java version
  ansible.builtin.command: java -version
  register: prepare_kvm_java_version
  changed_when: false
  failed_when: false

- name: Ensure Java 17 is selected
  ansible.builtin.command: update-alternatives --set java /usr/lib/jvm/java-17-openjdk-amd64/bin/java
  when: "'17' not in (prepare_kvm_java_version.stderr | default(''))"
  failed_when: false
  changed_when: true

- name: Configure guest CPU mode
  ansible.builtin.lineinfile:
    path: "{{ prepare_kvm_agent_properties_file }}"
    regexp: "^#?guest\\.cpu\\.mode="
    line: "guest.cpu.mode={{ prepare_kvm_guest_cpu_mode }}"
    create: true
    mode: "0644"
  when: prepare_kvm_guest_cpu_mode | length > 0
  notify: Restart CloudStack Agent

- name: Configure guest CPU model
  ansible.builtin.lineinfile:
    path: "{{ prepare_kvm_agent_properties_file }}"
    regexp: "^#?guest\\.cpu\\.model="
    line: "guest.cpu.model={{ prepare_kvm_guest_cpu_model }}"
    create: true
    mode: "0644"
  when:
    - prepare_kvm_guest_cpu_mode == "custom"
    - prepare_kvm_guest_cpu_model | length > 0
  notify: Restart CloudStack Agent

- name: Configure guest CPU features
  ansible.builtin.lineinfile:
    path: "{{ prepare_kvm_agent_properties_file }}"
    regexp: "^#?guest\\.cpu\\.features="
    line: "guest.cpu.features={{ prepare_kvm_guest_cpu_features }}"
    create: true
    mode: "0644"
  when: prepare_kvm_guest_cpu_features | length > 0
  notify: Restart CloudStack Agent

- name: Configure sudoers for CloudStack
  ansible.builtin.copy:
    dest: /etc/sudoers.d/cloudstack
    content: |
      cloudstack ALL=NOPASSWD: /usr/bin/cloudstack-setup-agent
      Defaults:cloudstack !requiretty
    mode: "0440"
    validate: "visudo -cf %s"
