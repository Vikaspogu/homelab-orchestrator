# Prepare KVM Role - Main Tasks
---
- name: Verify supported OS family
  ansible.builtin.fail:
    msg: "This role only supports Debian/Ubuntu. Detected: {{ ansible_os_family }}"
  when: ansible_os_family != "Debian"

- name: Include OS-specific variables
  ansible.builtin.include_vars: "Debian.yml"
  tags:
    - always

- name: Prepare KVM Host OS
  ansible.builtin.include_tasks: kvm_prepare_os.yml
  tags:
    - prepare
    - os

- name: Configure CloudStack repository
  ansible.builtin.include_tasks: configure_repo.yml
  tags:
    - repository
    - repo

- name: Install and configure libvirt
  ansible.builtin.include_tasks: kvm_install_libvirt.yml
  tags:
    - libvirt
    - kvm

- name: Configure security policies (AppArmor)
  ansible.builtin.include_tasks: kvm_configure_apparmor.yml
  tags:
    - security
    - apparmor

- name: Configure networking
  ansible.builtin.include_tasks: kvm_configure_network.yml
  tags:
    - network
    - bridges

- name: Configure firewall
  ansible.builtin.include_tasks: kvm_configure_firewall.yml
  when: cloudstack_configure_firewall
  tags:
    - firewall
    - ufw

- name: Install and configure CloudStack Agent
  ansible.builtin.include_tasks: kvm_install_agent.yml
  tags:
    - agent
    - cloudstack

- name: Configure local storage
  ansible.builtin.include_tasks: kvm_configure_local_storage.yml
  when: cloudstack_local_storage_enabled
  tags:
    - storage
    - local_storage

- name: Configure VFIO for GPU passthrough
  ansible.builtin.include_tasks: kvm_configure_vfio_gpu.yml
  when: cloudstack_vfio_gpu_enabled
  tags:
    - vfio
    - gpu
    - passthrough
