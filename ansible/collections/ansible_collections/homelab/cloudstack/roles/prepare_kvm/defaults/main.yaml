# Prepare KVM Role - Default Variables
---
# CloudStack version
prepare_kvm_version: ""

# Hostname configuration
prepare_kvm_hostname: "{{ ansible_facts['fqdn'] }}"

# CloudStack repository URLs
prepare_kvm_repo_base_url_ubuntu: "https://download.cloudstack.org/ubuntu"
prepare_kvm_repo_base_url_debian: "https://download.cloudstack.org/debian"
prepare_kvm_repo_gpg_key: "https://download.cloudstack.org/release.asc"

# Service management
prepare_kvm_enable_services: true
prepare_kvm_start_services: true

# Libvirt configuration
prepare_kvm_libvirt_listen_tls: 0
prepare_kvm_libvirt_listen_tcp: 0
prepare_kvm_libvirt_tls_port: "16514"
prepare_kvm_libvirt_tcp_port: "16509"
prepare_kvm_libvirt_auth_tcp: "none"
prepare_kvm_libvirt_mdns_adv: 0

# Guest CPU configuration
# Options: custom, host-model, host-passthrough
prepare_kvm_guest_cpu_mode: "host-passthrough"
prepare_kvm_guest_cpu_model: ""  # Used with custom mode
prepare_kvm_guest_cpu_features: ""  # e.g., "vmx avx -mmx"

# Network bridge configuration
prepare_kvm_network_mode: "advanced"  # Options: basic, advanced

# Management bridge (cloudbr0)
prepare_kvm_mgmt_bridge: "cloudbr0"
prepare_kvm_mgmt_interface: "eth0"
prepare_kvm_mgmt_ip: "{{ ansible_facts['default_ipv4']['address'] | default('') }}"
prepare_kvm_mgmt_netmask: "{{ ansible_facts['default_ipv4']['netmask'] | default('255.255.255.0') }}"
prepare_kvm_mgmt_prefix: "24"
prepare_kvm_mgmt_gateway: "{{ ansible_facts['default_ipv4']['gateway'] | default('') }}"
prepare_kvm_mgmt_dns: ["8.8.8.8", "8.8.4.4"]
prepare_kvm_mgmt_domain: "{{ ansible_facts['domain'] | default('local') }}"

# Guest bridge configuration
prepare_kvm_guest_bridge: "cloudbr0"
prepare_kvm_guest_interface: "eth0"
prepare_kvm_guest_vlan: ""

# Bridge STP settings
prepare_kvm_bridge_stp: "off"
prepare_kvm_bridge_fd: 5
prepare_kvm_bridge_maxwait: 1

# Use netplan (Ubuntu 20.04+)
prepare_kvm_use_netplan: true

# Firewall configuration
prepare_kvm_configure_firewall: true
prepare_kvm_firewall_ports:
  - { port: 22, proto: tcp }
  - { port: 1798, proto: tcp }
  - { port: 16514, proto: tcp }
  - { port: "5900:6100", proto: tcp }
  - { port: "49152:49216", proto: tcp }

# AppArmor configuration
prepare_kvm_disable_apparmor_libvirt: true

# Non-root user for adding host (optional)
prepare_kvm_host_user: ""

# SSH configuration for CloudStack management access
prepare_kvm_enable_pass_auth: true
prepare_kvm_root_password: ""
prepare_kvm_ssh_user: ""
prepare_kvm_mgmt_ssh_public_key: ""

# Local storage configuration
prepare_kvm_local_storage_enabled: true
prepare_kvm_local_storage_path: "/var/lib/libvirt/images"
prepare_kvm_local_storage_owner: "root"
prepare_kvm_local_storage_group: "root"
prepare_kvm_local_storage_mode: "0755"

# Additional storage devices (NVMe, SSD, etc.)
# Multiple disks are merged into a single pool using MergeFS
prepare_kvm_additional_storage: []
# Example - multiple disks merged into one:
#   - device: "/dev/nvme0n1"
#     filesystem: "xfs"
#     mount_options: "noatime,nodiratime,discard"
#     label: "nvme-disk0"
#   - device: "/dev/nvme1n1"
#     filesystem: "xfs"
#     label: "nvme-disk1"
#   - device: "/dev/sdb"
#     filesystem: "xfs"
#     label: "ssd-disk0"

# MergeFS configuration - combines all additional_storage disks into one pool
prepare_kvm_mergefs_mount_point: "/mnt/cloudstack-storage"  # Unified mount point for CloudStack
prepare_kvm_mergefs_branch_path: "/mnt/disks"               # Where individual disks are mounted
# MergeFS policy options:
#   - mfs (most free space) - writes to disk with most free space
#   - lfs (least free space) - writes to disk with least free space  
#   - epmfs (existing path, most free space) - keeps files together, balances new writes
#   - rand - random distribution
prepare_kvm_mergefs_options: "defaults,allow_other,use_ino,cache.files=partial,dropcacheonclose=true,category.create=mfs"

# UEFI support
prepare_kvm_uefi_support: false

# Secondary storage bypass support (aria2)
prepare_kvm_aria2_support: false

# VFIO GPU Passthrough configuration
prepare_kvm_vfio_gpu_enabled: false
prepare_kvm_vfio_reboot: true
