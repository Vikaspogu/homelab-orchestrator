# CloudStack Network Bridge Configuration (Netplan)
# Managed by Ansible - Do not edit manually
---
network:
  version: 2
  ethernets:
    {{ prepare_kvm_mgmt_interface }}:
      dhcp4: false
      dhcp6: false
{% if prepare_kvm_network_mode == 'advanced' and prepare_kvm_guest_interface != prepare_kvm_mgmt_interface %}
    {{ prepare_kvm_guest_interface }}:
      dhcp4: false
      dhcp6: false
{% endif %}
{% if prepare_kvm_network_mode == 'basic' and prepare_kvm_guest_vlan %}
  vlans:
    {{ prepare_kvm_mgmt_interface }}.{{ prepare_kvm_guest_vlan }}:
      id: {{ prepare_kvm_guest_vlan }}
      link: {{ prepare_kvm_mgmt_interface }}
{% endif %}
  bridges:
    {{ prepare_kvm_mgmt_bridge }}:
      addresses:
        - {{ prepare_kvm_mgmt_ip }}/{{ prepare_kvm_mgmt_prefix | default('24') }}
      routes:
        - to: default
          via: {{ prepare_kvm_mgmt_gateway }}
      nameservers:
        addresses:
{% for dns in prepare_kvm_mgmt_dns %}
          - {{ dns }}
{% endfor %}
{% if prepare_kvm_mgmt_domain %}
        search:
          - {{ prepare_kvm_mgmt_domain }}
{% endif %}
      interfaces:
        - {{ prepare_kvm_mgmt_interface }}
      parameters:
        stp: {{ 'true' if prepare_kvm_bridge_stp in ['on', 'yes', true, 'true'] else 'false' }}
        forward-delay: {{ prepare_kvm_bridge_fd }}
{% if prepare_kvm_guest_bridge != prepare_kvm_mgmt_bridge %}
{# Only create separate guest bridge if it differs from management bridge #}
    {{ prepare_kvm_guest_bridge }}:
      dhcp4: false
{% if prepare_kvm_network_mode == 'advanced' %}
      interfaces:
        - {{ prepare_kvm_guest_interface }}
{% elif prepare_kvm_network_mode == 'basic' and prepare_kvm_guest_vlan %}
      interfaces:
        - {{ prepare_kvm_mgmt_interface }}.{{ prepare_kvm_guest_vlan }}
{% endif %}
      parameters:
        stp: {{ 'true' if prepare_kvm_bridge_stp in ['on', 'yes', true, 'true'] else 'false' }}
        forward-delay: {{ prepare_kvm_bridge_fd }}
{% endif %}
